<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All requests</title>
    <link rel="icon" type="image/x-icon" href="images/dashboard.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Your existing styles remain exactly the same */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #d32f2f;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        .admin-header {
            background: rgb(4, 4, 118);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 7.4rem;
            position: relative;
        }

        #admin-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 15px;
            margin-top: 9px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            padding-left: 10rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            margin-left: -50px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 600;
            flex: 1;
            margin: 0;
            font-family: Georgia, 'Times New Roman', Times, serif;

        }

        .requests-table-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-left: 30px;
        }

        .download {
            background: rgb(212, 180, 132);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgb(27, 24, 24);
            font-weight: 600;
        }

        .download:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(212, 180, 132, 0.6);
            background: rgb(230, 200, 150);
        }

        .download:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(212, 180, 132, 0.3);
        }


        .table-wrapper {
            background: white;
            border-radius: 12px 12px 0 0;
            /* Top corners rounded, bottom flat */
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #667eea;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        #requests-table {
            width: 100%;
            border-collapse: collapse;
        }

        #requests-table thead {
            background: rgb(4, 4, 118);
            color: white;
        }

        #requests-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Column width adjustments */
        #requests-table th:nth-child(1),
        /* Request # */
        #requests-table td:nth-child(1) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(2),
        /* Status */
        #requests-table td:nth-child(2) {
            width: 110px;
            min-width: 110px;
        }

        #requests-table th:nth-child(3),
        /* College / Center */
        #requests-table td:nth-child(3) {
            width: 200px;
            min-width: 200px;
        }

        #requests-table th:nth-child(4),
        /* Department */
        #requests-table td:nth-child(4) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(5),
        /* Location */
        #requests-table td:nth-child(5) {
            width: 130px;
            min-width: 130px;
        }

        #requests-table th:nth-child(6),
        /* Issue Description */
        #requests-table td:nth-child(6) {
            width: 250px;
            min-width: 250px;
            max-width: 300px;
        }

        #requests-table th:nth-child(7),
        /* Date */
        #requests-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(8),
        /* Amount */
        #requests-table td:nth-child(8) {
            width: 110px;
            min-width: 110px;
            text-align: center;
        }

        #requests-table tbody tr {
            border-bottom: 1px solid #e8eef3;
            transition: background-color 0.2s ease;
        }

        #requests-table tbody tr:hover {
            background-color: #f8f9ff;
        }

        #requests-table tbody tr:last-child {
            border-bottom: none;
        }

        #requests-table td {
            padding: 16px;
            color: #2c3e50;
            font-size: 14px;
        }

        /* Status badge styling */
        .status-waiting {
            color: #e64d4d;
            background-color: #f4d4d4;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-Approved {
            color: #FFB700;
            background-color: #fcedca;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-processing {
            color: #42794d;
            background-color: #d4edda;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-Completed {
            color: #09034D;
            background-color: #d7e3ff;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-rejected {
            color: #000000;
            background-color: #eeeeee;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        /* Request number styling */
        #requests-table td:first-child {
            font-weight: 600;
            color: #041358;
        }

        /* Loading spinner */
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Main header row - search on left, stats on right */
        .header-row {
            display: flex;
            align-items: stretch;
            gap: 86px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 30px;
        }

        /* Stats summary */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Creates 2 equal columns */
            gap: 20px;
            flex-direction: row;
            justify-content: flex-end;
            /* gap: 15px; */
            /* flex-wrap: nowrap;
            disables wrapping, rows all in one line */
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            width: 130px;
            height: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;

        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }

        .stat-card.active {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: scale(1.08);
            z-index: 10;
        }

        .stat-card.active:hover {
            transform: scale(1.12);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
        }

        .stat-card.total.active {
            background-color: #d8dfff;
            border: 3px solid #667eea;
        }

        .stat-card.waiting.active {
            background-color: #f4d4d4;
            border: 3px solid #e64d4d;
        }

        .stat-card.processing.active {
            background-color: #dff7e4;
            border: 3px solid #42794d;
        }

        .stat-card.rejected.active {
            border: 3px solid #000000;
            background-color: #eeeeee;
        }


        .stat-card h3 {
            color: #000000;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #2c3e50;
            font-size: 26px;
            font-weight: 700;
        }

        .stat-card.total {
            border: 2px solid #667eea;
            background-color: #eff2fd;
        }

        .stat-card.waiting {
            border: 2px solid #e64d4d;
            background-color: #f4d4d4;
        }

        .stat-card.processing {
            border: 2px solid #42794d;
            background-color: #dff7e4;
        }

        .stat-card.rejected {
            border: 2px solid #000000;
            background-color: #eeeeee;
        }

        /* Search and Filters Styling */
        .search-filters-container {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            /* Reduce space below the search row */
        }

        .search-bar {
            position: relative;
            flex: 1;
        }

        .search-bar input {
            width: 97%;
            padding: 10px 40px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 14px;
            pointer-events: none;
        }

        .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e0e0e0;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }

        .clear-search:hover {
            background: #d32f2f;
            color: white;
        }

        .clear-search.visible {
            display: flex;
        }

        .filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            max-width: 300px;
        }

        .filters select:focus,
        .filters input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
        }

        .clear-btn {
            padding: 8px 16px;
            background: #d3e4ff;
            color: rgb(0, 0, 0);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid #414082;
            font-size: 13px;
            width: 200px;
        }

        .clear-btn:hover {
            background: #414082;
            transform: translateY(-2px);
            color: white;
        }

        @media (max-width: 1200px) {
            .header-row {
                flex-direction: column;
            }

            .stats-container {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .filters select,
            .filters input[type="date"] {
                width: 100%;
            }

            .stats-container {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .account-menu {
            position: absolute;
            top: 40px;
            right: 34px;
            z-index: 1000;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4A5568;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden
        }

        .account-icon img {
            width: 50%;
            object-fit: cover;
        }

        .account-icon:hover {
            background-color: #f0f4f8;
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Clickable request number */
        .request-link {
            color: #08175c;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .request-link:hover {
            color: #4a5dc9;
            text-decoration: underline;
        }

        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dropdown-header .admin-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .dropdown-header .admin-email {
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item .icon {
            width: 20px;
            font-size: 16px;
        }

        .dropdown-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: #d32f2f;
        }

        .dropdown-item.logout:hover {
            background-color: #ffebee;
        }

        #requestModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        /* Modal content - scrolls inside */
        #requestModal>div {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            /* ‚Üê This makes modal scroll */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            margin: auto;
        }

        #requestModal button[onclick*="closeModal"] {
            position: sticky;
            top: -15px;
            z-index: 1;
        }

        /* ‚úÖ PAGINATION STYLES */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e8eef3;
            border-radius: 0 0 12px 12px;
            /* Top flat, bottom rounded */
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            /* Matches table shadow */
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            background: #16079C;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            background: #f5f7fa;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 36px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .page-number:hover {
            background: #e8eef3;
            border-color: #16079C;
        }

        .page-number.active {
            background: #16079C;
            color: white;
            border-color: #16079C;
            font-weight: 600;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        @media print {

            /* Hide everything except modal content */
            body * {
                visibility: hidden;
            }

            #modalContent,
            #modalContent * {
                visibility: visible;
            }

            /* Make modal take full page for printing */
            #requestModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white !important;
            }

            #modalContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                max-height: none;
                box-shadow: none;
                padding: 20px;
                overflow: visible;
            }

            /* Hide buttons when printing */
            .no-print {
                display: none !important;
            }

            /* Adjust header padding for print */
            h2 {
                padding-right: 0 !important;
            }
        }

        .amount-cell {
            font-weight: 600;
            color: #2e7d32;
        }

        .amount-cell.no-amount {
            color: #999;
            font-weight: normal;
        }
    </style>
</head>

<body>

    <!-- ============================================ -->
    <!-- AUTHENTICATION PROTECTION - START -->
    <!-- ============================================ -->
    <!-- <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const authConfig = {
            apiKey: "AIzaSyCibZPg1QZKtY7g3FHrl5AeZoSFI3xeid0",
            authDomain: "requests-ffdd6.firebaseapp.com",
            projectId: "requests-ffdd6",
            storageBucket: "requests-ffdd6.firebasestorage.app",
            messagingSenderId: "316405880275",
            appId: "1:316405880275:web:f4b271583e903ac639cb26"
        };

        const authApp = initializeApp(authConfig, 'adminAuth');
        const adminAuth = getAuth(authApp);

        console.log('üîç Checking authentication...');

        // Check sessionStorage (ATHAR Museum method)
        const isAuthenticated = sessionStorage.getItem('isAuthenticated');
        const userEmail = sessionStorage.getItem('userEmail');

        if (isAuthenticated !== 'true' || !userEmail) {
            console.log('‚ùå Not authenticated - redirecting to login');
            window.location.replace('login.html');
        } else {
            console.log('‚úÖ Authenticated as:', userEmail);

            // Update UI
            const adminEmailElement = document.querySelector('.admin-email');
            const adminNameElement = document.querySelector('.admin-name');

            if (adminEmailElement) {
                adminEmailElement.textContent = userEmail;
            }
            if (adminNameElement) {
                const displayName = userEmail.split('@')[0];
                adminNameElement.textContent = displayName;
            }
        }

        // Global logout function
        window.logout = async function () {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    console.log('üö™ Logging out...');

                    // Clear session
                    sessionStorage.clear();
                    localStorage.clear();

                    // Sign out from Firebase
                    await signOut(adminAuth);

                    console.log('‚úÖ Logged out successfully');
                    window.location.replace('login.html');
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force logout even if Firebase fails
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.replace('login.html');
                }
            }
        };
    </script> -->
    <!-- ============================================ -->
    <!-- AUTHENTICATION PROTECTION - END -->
    <!-- ============================================ -->

    <header class="admin-header">
        <div class="header-content">
            <div class="header-title">
                <img id="admin-img" src="images/dashboard.png">
                <button onclick="window.location.href='admin-dashboard.html'"
                    style="background: none; border: none; cursor: pointer; padding: 0;">
                    <h1 style="color: white; margin: 0;">Admin Dashboard</h1>
                </button>
            </div>
            <div class="account-menu">
                <div class="account-icon" id="accountIcon" onclick="window.location.href='my-account.html'">
                    <img src="images/user.png" alt="User Account">
                </div>
            </div>
        </div>
        </div>
    </header>

    <!-- REST OF YOUR HTML CONTINUES HERE... -->
    <div class="requests-table-container">
        <!-- Header row: Search/Filters on left, Stats on right -->
        <div class="header-row">
            <div class="stats-container" id="stats-container">
                <div class="stat-card total" onclick="filterByStatus('')" id="card-total">
                    <h3>Total Requests</h3>
                    <p id="stat-total">0</p>
                </div>
                <div class="stat-card waiting" onclick="filterByStatus('Waiting')" id="card-waiting">
                    <h3>Waiting</h3>
                    <p id="stat-waiting">0</p>
                </div>
                <div class="stat-card processing" onclick="filterByStatus('Processing')" id="card-processing">
                    <h3>Processing</h3>
                    <p id="stat-processing">0</p>
                </div>
                <div class="stat-card rejected" onclick="filterByStatus('Rejected')" id="card-rejected">
                    <h3>rejected</h3>
                    <p id="stat-rejected">0</p>
                </div>
            </div>
            <!-- Search and Filters Section -->
            <div class="search-filters-container">
                <div class="search-row">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Search by Request #, Description, Location...">
                        <button class="clear-search" id="clearSearch" onclick="clearSearchInput()">√ó</button>
                    </div>
                </div>
                <div class="filters">
                    <select id="filterCollege">
                        <option value="">All Colleges</option>
                        <option value="College of Applied Studies">College of Applied Studies</option>
                        <option value="College of Arts">College of Arts</option>
                        <option value="College of Business Adminstration">College of Business Administration</option>
                        <option value="College of Engineering">College of Engineering</option>
                        <option value="College of Health & Sport Sciences">College of Health & Sport Sciences</option>
                        <option value="College of Information Technology">College of Information Technology</option>
                        <option value="College of Law">College of Law</option>
                        <option value="College of Science">College of Science</option>
                        <option value="Alumni Club">Alumni Club</option>
                        <option value="Business Incubator Center">Business Incubator Center</option>
                        <option value="Career Counselling Office">Career Counselling Office</option>
                        <option value="Centre D'√©tudes Fran√ßaises">Centre D'√©tudes Fran√ßaises</option>
                        <option value="Cloud Innovation Center">Cloud Innovation Center</option>
                        <option value="Community Service and Continuing Education Center">Community Service and
                            Continuing
                            Education Center</option>
                        <option value="Confucius Institiute">Confucius Institute</option>
                        <option value="E-Learning Center">E-Learning Center</option>
                        <option value="English Language Center">English Language Center</option>
                        <option value="Information Technology Center">Information Technology Center</option>
                        <option value="Information and Follow-up Office">Information and Follow-up Office</option>
                        <option value="King Sejong Institiute for Teaching Korean">King Sejong Institute for Teaching
                            Korean
                        </option>
                        <option value="Legal Clinic & Human Rights Centre">Legal Clinic & Human Rights Centre</option>
                        <option value="Media Center">Media Center</option>
                        <option value="Quality Assurance and Accrediation Centre">Quality Assurance and Accreditation
                            Centre
                        </option>
                        <option value="Unit for Teaching Excellence and Leadership">Unit for Teaching Excellence and
                            Leadership</option>
                        <option value="Yunus Emre Institiute for Teaching Turkish">Yunus Emre Institute for Teaching
                            Turkish
                        </option>
                    </select>

                    <select id="filterStatus">
                        <option value="">All Status</option>
                        <option value="Waiting">Waiting for Approval</option>
                        <option value="Approved">Approved</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Rejected">Rejected</option>

                    </select>

                    <input type="date" id="filterDateFrom" placeholder="From Date">
                    <input type="date" id="filterDateTo" placeholder="To Date">

                    <button id="clearFilters" class="clear-btn">Clear Filters</button>
                </div>
            </div>
        </div>


        <div class="table-header">
            <h2> Maintenance Requests</h2>
            <button class="download" id="download">
                <span>üì• Download PDF</span>
            </button>
        </div>

        <div class="table-wrapper">
            <div id="loading" class="loading">Loading requests</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="requests-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Request #</th>
                        <th>Status</th>
                        <th>College / Center</th>
                        <th>Department</th>
                        <th>Location</th>
                        <th>Issue Description</th>
                        <th>Date</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="tickets-tbody">
                </tbody>
            </table>
        </div>
        <!-- ‚úÖ PAGINATION CONTROLS -->
        <div class="pagination-container" id="pagination-container" style="display: none;">
            <div class="pagination-info">
                <span id="pagination-info"></span>
            </div>
            <div class="pagination-controls">
                <div class="rows-per-page">
                    <label>Rows per page:</label>
                    <select id="rowsPerPage" onchange="changeRowsPerPage()">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button class="pagination-btn" id="prevBtn" onclick="prevPage()">‚Üê Previous</button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Firebase SDKs - YOUR EXISTING FIREBASE CODE -->
    <script type="module">

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCibZPg1QZKtY7g3FHrl5AeZoSFI3xeid0",
            authDomain: "requests-ffdd6.firebaseapp.com",
            databaseURL: "https://requests-ffdd6-default-rtdb.firebaseio.com",
            projectId: "requests-ffdd6",
            storageBucket: "requests-ffdd6.firebasestorage.app",
            messagingSenderId: "316405880275",
            appId: "1:316405880275:web:f4b271583e903ac639cb26",
            measurementId: "G-L0LR313Q4D"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRequestsData = [];
        let jobDescriptionsData = {}; // ‚úÖ NEW - Store job descriptions by request number
        let currentPage = 1;
        let rowsPerPage = 10;
        let filteredRequests = [];



        // ‚úÖ NEW FUNCTION: Load all job descriptions and calculate amounts
        async function loadJobDescriptions() {
            try {
                console.log('üìã Loading Job Descriptions...');

                // Try both possible collection names
                let jobDescSnapshot;
                try {
                    jobDescSnapshot = await getDocs(collection(db, 'JobDescriptions'));
                    console.log('‚úÖ Found JobDescriptions collection');
                } catch (e) {
                    console.log('‚ö†Ô∏è JobDescriptions not found, trying MaterialReport...');
                    jobDescSnapshot = await getDocs(collection(db, 'MaterialReport'));
                    console.log('‚úÖ Found MaterialReport collection');
                }

                jobDescSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const requestNumber = data.requestNumber || data['Request Number'];

                    console.log('üìÑ Processing document:', {
                        docId: docSnap.id,
                        requestNumber: requestNumber,
                        estimatedTotalCost: data.estimatedTotalCost,
                        totalCost: data.totalCost,
                        laborGrandTotal: data.laborGrandTotal,
                        allFields: Object.keys(data)
                    });

                    if (requestNumber) {
                        // Use estimatedTotalCost (contains materials + labor total)
                        const totalAmount = parseFloat(data.estimatedTotalCost) || 0;

                        jobDescriptionsData[requestNumber] = {
                            totalAmount: totalAmount,
                            estimatedTotalCost: data.estimatedTotalCost || 0,
                            totalCost: data.totalCost || 0,
                            laborGrandTotal: data.laborGrandTotal || 0,
                            materials: data.materials || [],
                            labor: data.labor || []
                        };

                        console.log(`‚úÖ ${requestNumber}: Total Amount = ${totalAmount.toFixed(2)} BD`);
                    }
                });

                console.log(`‚úÖ Loaded ${Object.keys(jobDescriptionsData).length} Job Descriptions`);
                console.log('üìä Job Descriptions Summary:', Object.keys(jobDescriptionsData).map(key => ({
                    requestNumber: key,
                    amount: jobDescriptionsData[key].totalAmount
                })));
            } catch (error) {
                console.error('‚ùå Error loading Job Descriptions:', error);
                console.error('Error details:', error.message);
            }
        }

        // ‚úÖ FUNCTION: Format amount with currency
        function formatAmount(requestNumber) {
            const jobDesc = jobDescriptionsData[requestNumber];

            if (jobDesc && jobDesc.totalAmount > 0) {
                return `${jobDesc.totalAmount.toFixed(2)} BD`;
            }

            return '-';
        }

        window.printRequestDetails = function (requestNumber) {
            console.log('üñ®Ô∏è Generating PDF for request:', requestNumber);

            const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
            if (!request) {
                alert('Request not found');
                return;
            }

            if (typeof jspdf === 'undefined') {
                alert('PDF library not loaded. Please refresh the page.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);

            // === HEADER ===
            doc.setFillColor(4, 4, 118);
            doc.rect(0, 0, pageWidth, 35, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('Request Details', pageWidth / 2, 15, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Request #: ${request['Request Number']}`, pageWidth / 2, 27, { align: 'center' });

            yPosition = 45;

            // === STATUS BADGE ===
            const status = request.Status || 'Waiting';
            const statusLower = status.toLowerCase();

            if (statusLower.includes('waiting')) {
                doc.setFillColor(230, 77, 77);
            } else if (statusLower.includes('approved')) {
                doc.setFillColor(255, 183, 0);
            } else if (statusLower.includes('processing') || statusLower.includes('progress')) {
                doc.setFillColor(66, 121, 77);
            } else if (statusLower.includes('completed')) {
                doc.setFillColor(9, 3, 77);
            } else if (statusLower.includes('rejected')) {
                doc.setFillColor(150, 150, 150);
            }

            doc.roundedRect(margin, yPosition, 40, 10, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(status, margin + 20, yPosition + 7, { align: 'center' });

            yPosition += 20;

            // Helper function to check if we need a new page
            function checkPageBreak(requiredSpace) {
                if (yPosition + requiredSpace > pageHeight - 20) {
                    doc.addPage();
                    yPosition = 20;
                    return true;
                }
                return false;
            }

            // === BASIC INFORMATION ===
            checkPageBreak(50);
            doc.setFillColor(240, 244, 255);
            doc.rect(margin, yPosition, contentWidth, 8, 'F');
            doc.setTextColor(4, 4, 118);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Basic Information', margin + 2, yPosition + 5.5);
            yPosition += 12;

            // Date Submitted
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Date Submitted:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(formatDate(request['Request Date'] || request.Date), margin + 45, yPosition);
            yPosition += 8;

            // Submitted By
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Submitted by:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(request['Name'] || request['Submitted by'] || 'N/A', margin + 45, yPosition);
            yPosition += 8;

            // College
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('College:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            const collegeText = mapCollegeName(request.College) || 'N/A';
            const collegeLines = doc.splitTextToSize(collegeText, contentWidth - 50);
            doc.text(collegeLines, margin + 45, yPosition);
            yPosition += 5 + (collegeLines.length * 5);

            // Department
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Department:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(request.Department || 'N/A', margin + 45, yPosition);
            yPosition += 8;

            // Location
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Location:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(request.Location || 'N/A', margin + 45, yPosition);
            yPosition += 8;

            // Mobile
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Mobile:', margin, yPosition);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(request['Mobile Number'] || 'N/A', margin + 45, yPosition);
            yPosition += 10;

            // === ISSUE DESCRIPTION ===
            checkPageBreak(40);
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Issue Description:', margin, yPosition);
            yPosition += 6;

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            const descriptionText = request.Description || 'N/A';
            const descLines = doc.splitTextToSize(descriptionText, contentWidth);

            descLines.forEach(line => {
                checkPageBreak(10);
                doc.text(line, margin, yPosition);
                yPosition += 5;
            });
            yPosition += 5;

            // === STATUS-SPECIFIC SECTIONS ===
            const statusCheck = (request.Status || '').toLowerCase();

            // Completed Section
            if (statusCheck.includes('completed')) {
                checkPageBreak(40);
                doc.setFillColor(227, 242, 253);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(21, 101, 192);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('‚úì Request Completed', margin + 2, yPosition + 5.5);
                yPosition += 12;

                if (request['Start Date'] || request['startingDate'] || request['Approved Date']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Start Date:', margin, yPosition);
                    doc.setTextColor(21, 101, 192);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDateOnly(request['Start Date'] || request['startingDate'] || request['Approved Date']), margin + 45, yPosition);
                    yPosition += 8;
                }

                if (request['End Date'] || request['endDate']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('End Date:', margin, yPosition);
                    doc.setTextColor(21, 101, 192);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDateOnly(request['End Date'] || request['endDate']), margin + 45, yPosition);
                    yPosition += 8;
                }

                if (request['Completed Date']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(21, 101, 192);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDate(request['Completed Date']), margin + 45, yPosition);
                    yPosition += 8;
                }
                yPosition += 5;
            }

            // Approved Section
            if (statusCheck.includes('approved')) {
                checkPageBreak(30);
                doc.setFillColor(255, 243, 224);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(230, 81, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Request Approved', margin + 2, yPosition + 5.5);
                yPosition += 12;

                if (request['Approved Date']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Approved On:', margin, yPosition);
                    doc.setTextColor(230, 81, 0);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDate(request['Approved Date']), margin + 45, yPosition);
                    yPosition += 8;
                }
                yPosition += 5;
            }

            // Rejected Section
            if (statusCheck.includes('rejected')) {
                checkPageBreak(40);
                doc.setFillColor(255, 235, 238);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(198, 40, 40);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('‚úó Request Rejected', margin + 2, yPosition + 5.5);
                yPosition += 12;

                doc.setTextColor(100, 100, 100);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Rejection Reason:', margin, yPosition);
                yPosition += 6;

                doc.setTextColor(198, 40, 40);
                doc.setFont(undefined, 'normal');
                const rejectionText = request['Rejection Reason'] || request['rejectionReason'] || 'No reason provided';
                const rejectionLines = doc.splitTextToSize(rejectionText, contentWidth);

                rejectionLines.forEach(line => {
                    checkPageBreak(10);
                    doc.text(line, margin, yPosition);
                    yPosition += 5;
                });
                yPosition += 5;

                if (request['Rejected Date'] || request['rejectedDate']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Rejected On:', margin, yPosition);
                    doc.setTextColor(198, 40, 40);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDate(request['Rejected Date'] || request['rejectedDate']), margin + 45, yPosition);
                    yPosition += 8;
                }
            }

            // Processing Section
            if (statusCheck.includes('processing') || statusCheck.includes('progress')) {
                checkPageBreak(30);
                doc.setFillColor(232, 245, 233);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(46, 125, 50);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Request in Processing', margin + 2, yPosition + 5.5);
                yPosition += 12;

                if (request['Start Date'] || request['startingDate'] || request['Approved Date']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Start Date:', margin, yPosition);
                    doc.setTextColor(46, 125, 50);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDateOnly(request['Start Date'] || request['startingDate'] || request['Approved Date']), margin + 45, yPosition);
                    yPosition += 8;
                }

                if (request['End Date']) {
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Expected End Date:', margin, yPosition);
                    doc.setTextColor(46, 125, 50);
                    doc.setFont(undefined, 'normal');
                    doc.text(formatDateOnly(request['End Date']), margin + 45, yPosition);
                    yPosition += 8;
                }
                yPosition += 5;
            }

            // === FOOTER ===
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(
                    `Page ${i} of ${totalPages}`,
                    pageWidth / 2,
                    pageHeight - 10,
                    { align: 'center' }
                );
                doc.text(
                    `Generated on: ${new Date().toLocaleString()}`,
                    margin,
                    pageHeight - 10
                );
            }

            // ‚úÖ PRINT DIRECTLY INSTEAD OF DOWNLOADING
            console.log('üìÑ Opening print dialog...');

            // Get the PDF as a blob URL
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);

            // Create hidden iframe
            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'fixed';
            printFrame.style.right = '0';
            printFrame.style.bottom = '0';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = 'none';

            document.body.appendChild(printFrame);

            // Load PDF and print
            printFrame.src = pdfUrl;
            printFrame.onload = function () {
                try {
                    printFrame.contentWindow.print();

                    // Clean up after a delay
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                        URL.revokeObjectURL(pdfUrl);
                        console.log('‚úÖ Print dialog closed');
                    }, 1000);
                } catch (error) {
                    console.error('‚ùå Print error:', error);
                    alert('Could not open print dialog. Please allow pop-ups for this site.');
                    document.body.removeChild(printFrame);
                    URL.revokeObjectURL(pdfUrl);
                }
            };
        };

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            try {
                if (dateValue.toDate) {
                    const date = dateValue.toDate();
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',

                    });
                }
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                    return dateValue;
                }
                if (dateValue instanceof Date) {
                    return dateValue.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                    });
                }
            } catch (error) {
                console.error('Error formatting date:', error);
            }
            return 'N/A';
        }

        function formatDateOnly(dateValue) {
            if (!dateValue) return 'N/A';
            try {
                if (dateValue.toDate) {
                    const date = dateValue.toDate();
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                    return dateValue;
                }
                if (dateValue instanceof Date) {
                    return dateValue.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                console.error('Error formatting date:', error);
            }
            return 'N/A';
        }

        function getStatusClass(status) {
            const statusLower = (status || '').toLowerCase();
            if (statusLower.includes('progress') || statusLower.includes('processing')) return 'status-processing';
            if (statusLower.includes('waiting')) return 'status-waiting';
            if (statusLower.includes('approved')) return 'status-Approved';
            if (statusLower.includes('completed')) return 'status-Completed';
            if (statusLower.includes('rejected')) return 'status-rejected';
            return 'status-waiting';
        }

        function formatStatus(status) {
            if (!status) return 'Waiting';
            return status;
        }

        function mapCollegeName(oldName) {
            const collegeMapping = {
                'Applied': 'College of Applied Studies',
                'Arts': 'College of Arts',
                'Business': 'College of Business Adminstration',
                'Engineering': 'College of Engineering',
                'Health': 'College of Health & Sport Sciences',
                'IT': 'College of Information Technology',
                'Law': 'College of Law',
                'Science': 'College of Science',
                'Alumni': 'Alumni Club',
                'BIC': 'Business Incubator Center',
                'Counselling': 'Career Counselling Office',
                'French': 'Centre D\'√©tudes Fran√ßaises',
                'Cloud': 'Cloud Innovation Center',
                'CI': 'Confucius Institiute',
                'E-Learning': 'E-Learning Center',
                'English': 'English Language Center',
                'ITC': 'Information Technology Center',
                'Follow-up': 'Information and Follow-up Office',
                'Korean': 'King Sejong Institiute for Teaching Korean',
                'Legal': 'Legal Clinic & Human Rights Centre',
                'Media': 'Media Center',
                'QA': 'Quality Assurance and Accrediation Centre',
                'Teaching': 'Unit for Teaching Excellence and Leadership',
                'Turkish': 'Yunus Emre Institiute for Teaching Turkish'
            };
            return collegeMapping[oldName] || oldName;
        }

        function updateStats(requests) {
            const stats = {
                total: requests.length,
                waiting: 0,
                inProgress: 0,
                rejected: 0
            };

            requests.forEach(req => {
                const status = (req.Status || '').toLowerCase();
                if (status.includes('progress') || status.includes('processing')) {
                    stats.inProgress++;
                } else if (status.includes('waiting') || status.includes('pending')) {
                    stats.waiting++;
                } else if (status.includes('rejected')) {
                    stats.rejected++;
                }
            });

            const totalElement = document.getElementById('stat-total');
            const waitingElement = document.getElementById('stat-waiting');
            const processingElement = document.getElementById('stat-processing');
            const rejectedElement = document.getElementById('stat-rejected');

            if (totalElement) totalElement.textContent = stats.total;
            if (waitingElement) waitingElement.textContent = stats.waiting;
            if (processingElement) processingElement.textContent = stats.inProgress;
            if (rejectedElement) rejectedElement.textContent = stats.rejected;
        }

        // ‚úÖ FIXED FILTER FUNCTION
        function filterAndDisplayRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const filterCollege = document.getElementById('filterCollege').value.trim();
            const filterStatus = document.getElementById('filterStatus').value.trim();
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;

            console.log('üîç FILTERING WITH:');
            console.log('Search:', searchTerm);
            console.log('College:', filterCollege);
            console.log('Status:', filterStatus);
            console.log('Date From:', filterDateFrom);
            console.log('Date To:', filterDateTo);

            const clearSearchBtn = document.getElementById('clearSearch');
            if (searchTerm) {
                clearSearchBtn.classList.add('visible');
            } else {
                clearSearchBtn.classList.remove('visible');
            }

            const tbody = document.getElementById("tickets-tbody");
            const table = document.getElementById("requests-table");
            tbody.innerHTML = "";

            filteredRequests = allRequestsData.filter(data => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (data['Request Number'] || '').toLowerCase().includes(searchTerm) ||
                    (data.Description || '').toLowerCase().includes(searchTerm) ||
                    (data.Location || '').toLowerCase().includes(searchTerm) ||
                    (data.College || '').toLowerCase().includes(searchTerm) ||
                    (data.Department || '').toLowerCase().includes(searchTerm);

                // College filter
                const matchesCollege = !filterCollege || mapCollegeName(data.College) === filterCollege;

                // ‚úÖ FIXED STATUS FILTER - handles all variations
                let matchesStatus = true;
                if (filterStatus) {
                    const dataStatus = (data.Status || 'Waiting').toLowerCase().trim();
                    const filterStatusLower = filterStatus.toLowerCase();

                    if (filterStatusLower === 'waiting' || filterStatusLower === 'waiting for approval') {
                        matchesStatus = dataStatus.includes('waiting');
                    } else if (filterStatusLower === 'approved') {
                        matchesStatus = dataStatus.includes('approved');
                    } else if (filterStatusLower === 'processing') {
                        matchesStatus = dataStatus.includes('processing') || dataStatus.includes('progress');
                    } else if (filterStatusLower === 'completed') {
                        matchesStatus = dataStatus.includes('completed') || dataStatus.includes('done');
                    } else if (filterStatusLower === 'rejected') {
                        matchesStatus = dataStatus.includes('rejected') || dataStatus.includes('reject');
                    } else {
                        matchesStatus = dataStatus === filterStatusLower;
                    }
                }

                // ‚úÖ FIXED DATE FILTER
                let matchesDate = true;
                if (filterDateFrom || filterDateTo) {
                    let requestDate;
                    if (data['Request Date']?.toDate) {
                        requestDate = data['Request Date'].toDate();
                    } else if (data.Date?.toDate) {
                        requestDate = data.Date.toDate();
                    } else {
                        requestDate = new Date(data['Request Date'] || data.Date);
                    }

                    requestDate.setHours(0, 0, 0, 0);

                    if (filterDateFrom) {
                        const fromDate = new Date(filterDateFrom);
                        fromDate.setHours(0, 0, 0, 0);
                        if (requestDate < fromDate) matchesDate = false;
                    }

                    if (filterDateTo) {
                        const toDate = new Date(filterDateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (requestDate > toDate) matchesDate = false;
                    }
                }

                return matchesSearch && matchesCollege && matchesStatus && matchesDate;
            });

            console.log('‚úÖ Filtered:', filteredRequests.length, 'requests');

            if (filteredRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No requests match your filters</td></tr>';
                table.style.display = "table";
                document.getElementById('pagination-container').style.display = 'none';
                updateStats(filteredRequests);
                return;
            }

            // Validate current page
            const totalPages = Math.ceil(filteredRequests.length / rowsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            paginatedRequests.forEach((data) => {
                const status = formatStatus(data.Status);
                const statusClass = getStatusClass(status);
                // ‚úÖ FIXED: Use data['Request Number']
                const amount = formatAmount(data['Request Number']);
                const modalHTML = `
                    <div id="requestModal" ...>
                    <div id="modalContent" ...>
                        ...
            
            ${amount !== '-' ? `
                    <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <p style="font-weight: 600; color: #2E7D32; margin-bottom: 5px;">Total Amount:</p>
                    <p style="color: #2E7D32; font-size: 24px; font-weight: bold;">${amount}</p>
                    </div>
                    ` : ''}
            
                    ...
        </div>
    </div>
`;
                const amountClass = amount === '-' ? 'amount-cell no-amount' : 'amount-cell'; // ‚úÖ NEW

                const row = document.createElement("tr");
                row.innerHTML = `
        <td><a href="#" class="request-link" onclick="viewRequestDetails('${data['Request Number']}'); return false;">${data['Request Number'] || 'N/A'}</a></td>
        <td><span class="${statusClass}">${status}</span></td>
        <td>${mapCollegeName(data.College) || 'N/A'}</td>
        <td>${data.Department || 'N/A'}</td>
        <td>${data.Location || 'N/A'}</td>
        <td>${data.Description || data.Issue || 'N/A'}</td>
        <td>${formatDate(data['Request Date'] || data['Date'])}</td>
        <td class="${amountClass}">${amount}</td>  <!-- ‚úÖ NEW COLUMN -->
    `;
                tbody.appendChild(row);
            });

            table.style.display = "table";
            updateStats(filteredRequests);
            updatePaginationUI(totalPages, startIndex, endIndex);
        }

        function updatePaginationUI(totalPages, startIndex, endIndex) {
            const paginationContainer = document.getElementById('pagination-container');
            const paginationInfo = document.getElementById('pagination-info');
            const pageNumbers = document.getElementById('pageNumbers');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (filteredRequests.length === 0) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            const showing = Math.min(endIndex, filteredRequests.length);
            paginationInfo.textContent = `Showing ${startIndex + 1}-${showing} of ${filteredRequests.length} requests`;

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstPage = document.createElement('button');
                firstPage.className = 'page-number';
                firstPage.textContent = '1';
                firstPage.onclick = () => goToPage(1);
                pageNumbers.appendChild(firstPage);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    ellipsis.style.color = '#666';
                    pageNumbers.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    ellipsis.style.color = '#666';
                    pageNumbers.appendChild(ellipsis);
                }

                const lastPage = document.createElement('button');
                lastPage.className = 'page-number';
                lastPage.textContent = totalPages;
                lastPage.onclick = () => goToPage(totalPages);
                pageNumbers.appendChild(lastPage);
            }
        }

        window.goToPage = function (page) {
            currentPage = page;
            filterAndDisplayRequests();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.nextPage = function () {
            if (currentPage < Math.ceil(filteredRequests.length / rowsPerPage)) {
                currentPage++;
                filterAndDisplayRequests();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.prevPage = function () {
            if (currentPage > 1) {
                currentPage--;
                filterAndDisplayRequests();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.changeRowsPerPage = function () {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            filterAndDisplayRequests();
        };

        async function loadRequests() {
            const tbody = document.getElementById("tickets-tbody");
            const loadingDiv = document.getElementById("loading");
            const errorDiv = document.getElementById("error");
            const table = document.getElementById("requests-table");

            try {
                tbody.innerHTML = "";
                loadingDiv.style.display = "block";
                errorDiv.style.display = "none";
                table.style.display = "none";

                // ‚úÖ Load job descriptions first
                await loadJobDescriptions();

                const requestsSnapshot = await getDocs(collection(db, "Requests"));
                loadingDiv.style.display = "none";

                if (requestsSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No requests found</td></tr>';
                    table.style.display = "table";
                    return;
                }

                allRequestsData = [];
                requestsSnapshot.forEach((docSnap) => {
                    allRequestsData.push(docSnap.data());
                });

                allRequestsData.sort((a, b) => {
                    const dateA = a['Request Date']?.toDate?.() || a.Date?.toDate?.() || new Date(a['Request Date'] || a.Date || 0);
                    const dateB = b['Request Date']?.toDate?.() || b.Date?.toDate?.() || new Date(b['Request Date'] || b.Date || 0);
                    return dateB - dateA;
                });

                console.log('‚úÖ Loaded', allRequestsData.length, 'requests');

                // ‚úÖ CHECK FOR URL PARAMETERS
                const urlParams = new URLSearchParams(window.location.search);
                const statusParam = urlParams.get('status');
                const dateFromParam = urlParams.get('dateFrom');
                const dateToParam = urlParams.get('dateTo');

                if (statusParam) {
                    console.log('üìå Applying URL status filter:', statusParam);
                    const capitalizedStatus = statusParam.charAt(0).toUpperCase() + statusParam.slice(1);
                    document.getElementById('filterStatus').value = capitalizedStatus;
                }

                if (dateFromParam) {
                    console.log('üìå Applying URL date from:', dateFromParam);
                    document.getElementById('filterDateFrom').value = dateFromParam;
                }

                if (dateToParam) {
                    console.log('üìå Applying URL date to:', dateToParam);
                    document.getElementById('filterDateTo').value = dateToParam;
                }

                filterAndDisplayRequests();

            } catch (error) {
                console.error("Error loading requests:", error);
                loadingDiv.style.display = "none";
                errorDiv.textContent = `Error loading requests: ${error.message}`;
                errorDiv.style.display = "block";
            }
        }

        window.closeModal = function () {
            const modal = document.getElementById('requestModal');
            if (modal) {
                modal.remove();
            }
            document.body.classList.remove('modal-open');
        };

        window.viewRequestDetails = function (requestNumber) {
            const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
            if (!request) {
                alert('Request not found');
                return;
            }

            const status = (request.Status || 'Waiting').toLowerCase();
            const showCompletedDates = status === 'completed';
            const showApprovedSection = status === 'approved' || status.includes('approved');
            const showRejectedSection = status === 'rejected' || status.includes('reject');
            const showProcessingSection = status === 'processing' || status.includes('progress');

            const modalHTML = `
    <div id="requestModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div id="modalContent" style="background: white; border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); position: relative;">
            <div class="no-print" style="position: absolute; top: 15px; right: 30px; display: flex; gap: 10px; align-items: center;">
    
    
    <!-- Print PDF Button (Circle) -->
    <button onclick="printRequestDetails('${request['Request Number']}')" 
            style="background: rgb(4, 4, 118,0.3); 
                   color: white; 
                   border: none; 
                   width: 45px; 
                   height: 45px; 
                   border-radius: 50%; 
                   font-size: 20px; 
                   cursor: pointer; 
                   transition: all 0.3s ease; 
                   display: flex; 
                   align-items: center; 
                   justify-content: center;
                   box-shadow: 0 2px 8px rgba(4,4,118,0.3);" 
            onmouseover="this.style.transform='scale(1.1)'" 
            onmouseout="this.style.transform='scale(1)'"
            title="Print PDF">
        <img src="images/printer.png"style="width:25px;height:25px">
    </button>
    
    <!-- View Job Button (Circle) -->
    <button onclick="viewMaterialReport('${request['Request Number']}')" 
            style="background: rgb(255, 152, 0, 0.4); 
                   color: white; 
                   border: none; 
                   width: 45px; 
                   height: 45px; 
                   border-radius: 50%; 
                   font-size: 20px; 
                   cursor: pointer; 
                   transition: all 0.3s ease; 
                   display: flex; 
                   align-items: center; 
                   justify-content: center;
                   box-shadow: 0 2px 8px rgba(255,152,0,0.3);" 
            onmouseover="this.style.transform='scale(1.1)'" 
            onmouseout="this.style.transform='scale(1)'"
            title="View Job Description">
                <img src="images/file.png"style="width:25px;height:25px">
    </button>
    <!-- Close Button (Circle) -->
    <button onclick="closeModal()" 
            style="background: rgba(207, 203,203,1); 
                   color: #333; 
                   border: none; 
                   width: 45px; 
                   height: 45px; 
                   border-radius: 50%; 
                   font-size: 22px; 
                   cursor: pointer; 
                   transition: all 0.3s ease; 
                   display: flex; 
                   align-items: center; 
                   justify-content: center; 
                   padding: 0;
                   box-shadow: 0 2px 8px rgba(0,0,0,0.15);" 
            onmouseover="this.style.background='#d32f2f'; this.style.color='white'; this.style.transform='scale(1.1)'" 
            onmouseout="this.style.background='#e0e0e0'; this.style.color='#333'; this.style.transform='scale(1)'">
        √ó
    </button>
</div>

            <h2 style="color: rgb(4, 4, 118); margin-bottom: 20px; font-size: 24px; border-bottom: 2px solid rgb(4, 4, 118); padding-bottom: 10px; padding-right: 120px;">Request Details</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Date Submitted:</p>
                        <p style="color: #2c3e50;">${formatDate(request['Request Date'] || request.Date)}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Submitted by:</p>
                        <p style="color: #2c3e50;">${request['Name'] || request['Submitted by'] || 'N/A'}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">College:</p>
                        <p style="color: #2c3e50;">${mapCollegeName(request.College) || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Department:</p>
                        <p style="color: #2c3e50;">${request.Department || 'N/A'}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Location:</p>
                        <p style="color: #2c3e50;">${request.Location || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Mobile:</p>
                        <p style="color: #2c3e50;">${request['Mobile Number'] || 'N/A'}</p>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Issue Description:</p>
                    <p style="color: #2c3e50; background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">${request.Description || 'N/A'}</p>
                </div>

                ${showCompletedDates ? `
                <div style="background: #E3F2FD; border: 2px solid #2196F3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #1565C0; margin-bottom: 15px; font-size: 18px;">‚úÖ Request Completed</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Start Date:</p>
                            <p style="color: #1565C0; font-weight: 600; font-size: 16px;">${request['Approved Date'] || request['Start Date'] || request['startingDate'] ? formatDateOnly(request['Approved Date'] || request['Start Date'] || request['startingDate']) : 'N/A'}</p>
                        </div>
                        <div>
                            <p style="font-weight: 600; color: #666; margin-bottom: 5px;">End Date:</p>
                            <p style="color: #1565C0; font-weight: 600; font-size: 16px;">${request['End Date'] || request['endDate'] ? formatDateOnly(request['End Date'] || request['endDate']) : 'N/A'}</p>
                        </div>
                    </div>

        
                </div>
                ` : ''}

                ${showApprovedSection ? `
                <div style="background: #FFF3E0; border: 2px solid #FF9800; border-radius: 10px; padding: 20px; margin-bottom: 20px;font-family:serif;">
                    <h3 style="color: #E65100; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 8px;"><img src="images/contract.png" style="width:25px;height:25px;margin-right:5px;"> Assign Materials & Labor</h3>
                    
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">This request has been approved. Click below to assign materials and labor for this job.</p>
                    
                     <div style="display: flex; justify-content: center;">
                        <button onclick="checkAndRedirectToMaterialReport('${request['Request Number']}')" style="background: #FF9800;float:center; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 50%; transition: all 0.3s ease;" onmouseover="this.style.background='#F57C00'" onmouseout="this.style.background='#FF9800'">
                        Create Job Description
                    </button>
                    </div>
                    

                    ${request['Approved Date'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #FFE0B2;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Approved On:</p>
                        <p style="color: #E65100; font-size: 14px;">${formatDate(request['Approved Date'])}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                ${showRejectedSection ? `
                <div style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #C62828; margin-bottom: 15px; font-size: 18px;">‚ùå Request Rejected</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 8px;">Reason for Rejection:</p>
                        <p style="color: #C62828; background: #FFCDD2; padding: 12px; border-radius: 6px; line-height: 1.6; white-space: pre-wrap;">${request['Rejection Reason'] || request['rejectionReason'] || 'No reason provided'}</p>
                    </div>

                    ${request['Rejected Date'] || request['rejectedDate'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #FFCDD2;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Rejected On:</p>
                        <p style="color: #C62828; font-size: 14px;">${formatDate(request['Rejected Date'] || request['rejectedDate'])}</p>
                    </div>
                    ` : ''}

                    ${request['Rejected By'] || request['rejectedBy'] ? `
                    <div style="margin-top: 10px;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Rejected By:</p>
                        <p style="color: #C62828; font-size: 14px;">${request['Rejected By'] || request['rejectedBy']}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                ${showProcessingSection ? `
                <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #2E7D32; margin-bottom: 15px; font-size: 18px;">üìÖ Set Completion Date</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: #666; margin-bottom: 8px;">End Date (must be today or in the past):</label>
                        <input type="date" id="endDateInput" value="${request['End Date'] || ''}" max="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 12px; border: 2px solid #4CAF50; border-radius: 8px; font-size: 14px;" />
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">‚ö†Ô∏è Date must be today or earlier. Setting a past/today date will mark as Completed.</p>
                    </div>
                    
                    <button onclick="saveEndDate('${request['Request Number']}')" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">Save End Date & Complete</button>
                    
                    ${request['End Date'] ? `<p style="margin-top: 15px; color: #2E7D32; font-size: 14px; text-align: center;">‚úì Current end date: ${formatDateOnly(request['End Date'])}</p>` : ''}

                    ${request['Approved Date'] || request['Start Date'] || request['startingDate'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #C8E6C9;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Start Date:</p>
                        <p style="color: #2E7D32; font-size: 14px;">${formatDateOnly(request['Start Date'] || request['startingDate'] || request['Approved Date'])}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
        </div>
    `;

            const existingModal = document.getElementById('requestModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.classList.add('modal-open');
        };

        // ‚úÖ ADD THIS NEW FUNCTION for redirecting to job description
        window.redirectToMaterialReport = function (requestNumber) {
            // Store request number in session storage
            sessionStorage.setItem('selectedRequestNumber', requestNumber);

            // Close modal
            closeModal();

            // Redirect to job description page
            window.location.href = 'material-report.html?request=' + requestNumber;
        };
        window.viewMaterialReport = async function (requestNumber) {
            console.log('üìã Fetching Job Description for:', requestNumber);

            try {
                // Fetch Job Description from Firebase
                const jobDescRef = collection(db, 'JobDescriptions');
                const jobDescSnapshot = await getDocs(jobDescRef);

                let jobDescData = null;
                let jobDescId = null;

                // Search for matching Job Description
                jobDescSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();

                    // ‚úÖ Check BOTH possible field name variations
                    const docRequestNum = data.requestNumber || data['Request Number'];

                    console.log(`Checking Job Desc ${docSnap.id.substring(0, 8)}: requestNumber = "${docRequestNum}"`);

                    if (docRequestNum === requestNumber) {
                        jobDescData = data;
                        jobDescId = docSnap.id;
                        console.log('‚úÖ MATCH FOUND!');
                    }
                });

                // ‚ùå No Job Description found
                if (!jobDescData) {
                    console.log('‚ùå No Job Description found for:', requestNumber);
                    alert('‚ùå No Job Description Found\n\nThis request does not have materials and labor assigned yet.');
                    return;
                }

                // ‚úÖ Job Description found!
                console.log('‚úÖ Job Description found:', jobDescData);
                console.log('Document ID:', jobDescId);

                // Store data in localStorage for the Job Description page
                localStorage.setItem('selectedRequestNumber', requestNumber);
                localStorage.setItem('jobDescriptionData', JSON.stringify(jobDescData));
                localStorage.setItem('jobDescriptionId', jobDescId);
                localStorage.setItem('viewMode', 'view');

                // Also store the original request data
                const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
                if (request) {
                    localStorage.setItem('selectedRequestData', JSON.stringify(request));
                }

                // Close modal
                closeModal();

                // Redirect to Job Description page
                console.log('üîÑ Redirecting to material-report.html...');
                window.location.href = 'material-report.html?request=' + requestNumber + '&mode=view';

            } catch (error) {
                console.error('‚ùå Error fetching Job Description:', error);
                console.error('Full error:', error.stack);
                alert('Error loading Job Description:\n\n' + error.message + '\n\nPlease check the console for details.');
            }
        };

        // ‚úÖ ENHANCED saveEndDate function with validation
        window.saveEndDate = async function (requestNumber) {
            const endDateInput = document.getElementById('endDateInput');
            const endDate = endDateInput?.value;

            if (!endDate) {
                alert('Please select an end date');
                return;
            }

            const selectedDate = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);

            // ‚úÖ VALIDATION: End date must be today or in the past
            if (selectedDate > today) {
                alert('‚ùå End date cannot be in the future! Please select today or an earlier date.');
                return;
            }

            const shouldComplete = selectedDate <= today;
            const newStatus = shouldComplete ? 'Completed' : 'Processing';

            const message = shouldComplete
                ? 'This date is today or in the past. The request status will be changed to "Completed". Continue?'
                : 'Save this end date for the request?';

            if (!confirm(message)) return;

            try {
                const requestsRef = collection(db, 'Requests');
                const querySnapshot = await getDocs(requestsRef);

                let docId = null;
                querySnapshot.forEach((docSnap) => {
                    if (docSnap.data()['Request Number'] === requestNumber) {
                        docId = docSnap.id;
                    }
                });

                if (docId) {
                    const updateData = {
                        'End Date': endDate,
                        'End Date Updated': serverTimestamp()
                    };

                    if (shouldComplete) {
                        updateData['Status'] = 'Completed';
                        updateData['Completed Date'] = serverTimestamp();
                    }

                    await updateDoc(doc(db, 'Requests', docId), updateData);

                    const successMessage = shouldComplete
                        ? 'End date saved successfully! Request status changed to Completed.'
                        : 'End date saved successfully!';

                    alert(successMessage);

                    const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
                    if (request) {
                        request['End Date'] = endDate;
                        if (shouldComplete) request['Status'] = 'Completed';
                    }

                    await loadRequests();
                    closeModal();

                    if (!shouldComplete) {
                        setTimeout(() => viewRequestDetails(requestNumber), 500);
                    }

                } else {
                    alert('Error: Request not found in database');
                }

            } catch (error) {
                console.error('Error saving end date:', error);
                alert('Error: ' + error.message);
            }
        };

        // ‚úÖ FIXED FILTER BY STATUS
        window.filterByStatus = function (status) {
            console.log('üéØ filterByStatus called with:', status);
            document.getElementById('filterStatus').value = status;

            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));

            if (status === '') {
                document.getElementById('card-total').classList.add('active');
            } else if (status.toLowerCase() === 'waiting') {
                document.getElementById('card-waiting').classList.add('active');
            } else if (status.toLowerCase() === 'processing') {
                document.getElementById('card-processing').classList.add('active');
            } else if (status.toLowerCase() === 'rejected') {
                document.getElementById('card-rejected').classList.add('active');
            }

            filterAndDisplayRequests();
        };

        window.clearSearchInput = function () {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.remove('visible');
            filterAndDisplayRequests();
        };

        // ‚úÖ EVENT LISTENERS
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterCollege').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterStatus').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterDateFrom').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterDateTo').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterCollege').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('clearSearch').classList.remove('visible');

            // Remove active state from all stat cards
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            document.getElementById('card-total').classList.add('active');

            filterAndDisplayRequests();
        });

        loadRequests();
        setInterval(loadRequests, 100000);

        document.getElementById('download').addEventListener('click', function () {
            console.log('üì• Download PDF button clicked');

            if (typeof jspdf === 'undefined') {
                alert('PDF library not loaded. Please refresh the page.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            // Add title
            doc.setFontSize(18);
            doc.setTextColor(4, 4, 118);
            doc.text('Maintenance Requests Report', 14, 15);

            // Add date
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);

            // Prepare table data
            const tableData = filteredRequests.map(req => [
                req['Request Number'] || 'N/A',
                req.Status || 'Waiting',
                mapCollegeName(req.College) || 'N/A',
                req.Department || 'N/A',
                req.Location || 'N/A',
                req.Description || 'N/A',
                formatDate(req['Request Date'] || req.Date),
                formatAmount(req['Request Number']) // ‚úÖ NEW
            ]);

            doc.autoTable({
                head: [['Request #', 'Status', 'College/Center', 'Department', 'Location', 'Description', 'Date', 'Amount']], // ‚úÖ Added Amount
                body: tableData,
                startY: 28,
                theme: 'striped',
                headStyles: {
                    fillColor: [4, 4, 118],
                    textColor: [255, 255, 255],
                    fontSize: 10,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 9
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                columnStyles: {
                    0: { cellWidth: 28 },
                    1: { cellWidth: 22 },
                    2: { cellWidth: 42 },
                    3: { cellWidth: 32 },
                    4: { cellWidth: 28 },
                    5: { cellWidth: 55 },
                    6: { cellWidth: 32 },
                    7: { cellWidth: 30, halign: 'center' } // ‚úÖ NEW - Amount column
                },
                margin: { top: 28, left: 14, right: 14 },
                styles: {
                    overflow: 'linebreak',
                    cellPadding: 3,
                    fontSize: 8
                }
            });

            // Add page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(
                    `Page ${i} of ${pageCount}`,
                    doc.internal.pageSize.getWidth() / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }

            // Save PDF
            const filename = `Maintenance_Requests_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);

            console.log('‚úÖ PDF downloaded:', filename);
        });


    </script>

</body>

</html>