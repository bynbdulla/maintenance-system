<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All requests</title>
    <link rel="icon" type="image/x-icon" href="images/dashboard.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- ‚úÖ NEW -->

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Amiri&display=swap");

        :root {
            /* New Color Palette */
            --navy: #2F4456;
            --teal: #567C8D;
            --sky-blue: #C8D9E6;
            --beige: #F5EFEB;
            --white: #FFFFFF;

            /* Functional colors */
            --primary: var(--navy);
            --secondary: var(--teal);
            --accent: var(--sky-blue);
            --background: var(--beige);
            --text-dark: #2c2c2c;
            --text-light: #5a5a5a;
        }

        .mixed-content {
            font-family: "Amiri", serif;
            /* This automatically handles RTL for Arabic and LTR for English */
            unicode-bidi: plaintext;
            text-align: start;
            line-height: 1.8;
        }

        /* Your existing styles remain exactly the same */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #d32f2f;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }



        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--beige);
            min-height: 100vh;
        }

        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        .admin-header {
            background: var(--navy);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 7.4rem;
            position: relative;
        }

        #admin-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 15px;
            margin-top: 9px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            padding-left: 10rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            margin-left: -50px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 600;
            flex: 1;
            margin: 0;
            font-family: Georgia, 'Times New Roman', Times, serif;

        }

        .requests-table-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            color: var(--navy);
            font-size: 24px;
            font-weight: 600;
            margin-left: 30px;
        }

        .download {
            background: var(--teal);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: 600;
        }

        .download:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(86, 124, 141, 0.6);
            background: var(--navy);
        }

        .download:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(86, 124, 141, 0.3);
        }


        .table-wrapper {
            background: white;
            border-radius: 12px 12px 0 0;
            /* Top corners rounded, bottom flat */
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: var(--navy);
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background-color: #ffebee;
            border-radius: 4px;
            margin: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        #requests-table {
            width: 100%;
            border-collapse: collapse;
        }

        #requests-table thead {
            background: var(--navy);
            color: white;
        }

        #requests-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Column width adjustments */
        #requests-table th:nth-child(1),
        /* Request # */
        #requests-table td:nth-child(1) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(2),
        /* Status */
        #requests-table td:nth-child(2) {
            width: 110px;
            min-width: 110px;
        }

        #requests-table th:nth-child(3),
        /* College / Center */
        #requests-table td:nth-child(3) {
            width: 200px;
            min-width: 200px;
        }

        #requests-table th:nth-child(4),
        /* Department */
        #requests-table td:nth-child(4) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(5),
        /* Location */
        #requests-table td:nth-child(5) {
            width: 130px;
            min-width: 130px;
        }

        #requests-table th:nth-child(6),
        /* Issue Description */
        #requests-table td:nth-child(6) {
            width: 250px;
            min-width: 250px;
            max-width: 300px;
        }

        #requests-table th:nth-child(7),
        /* Date */
        #requests-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
        }

        #requests-table th:nth-child(8),
        /* Amount */
        #requests-table td:nth-child(8) {
            width: 110px;
            min-width: 110px;
            text-align: center;
        }

        #requests-table tbody tr {
            border-bottom: 1px solid #e8eef3;
            transition: background-color 0.2s ease;
        }

        #requests-table tbody tr:hover {
            background-color: var(--sky-blue);
        }

        #requests-table tbody tr:last-child {
            border-bottom: none;
        }

        #requests-table td {
            padding: 16px;
            color: #2c3e50;
            font-size: 14px;
        }

        .status-waiting {
            color: #83792c;
            background-color: #f7f5dac2;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-Approved {
            color: var(--teal);
            background-color: var(--sky-blue);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-processing {
            color: var(--navy);
            background-color: var(--sky-blue);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        .status-Completed {
            color: var(--navy);
            background-color: var(--beige);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            border: 1px solid var(--teal);
        }

        .status-rejected {
            color: #666;
            background-color: #e0e0e0;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
        }

        /* Request number styling */
        #requests-table td:first-child {
            font-weight: 600;
            color: #041358;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--navy);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Main header row - search on left, stats on right */
        .header-row {
            display: flex;
            align-items: stretch;
            gap: 86px;
            margin-bottom: 30px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 30px;
        }

        /* Stats summary */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Creates 2 equal columns */
            gap: 20px;
            flex-direction: row;
            justify-content: flex-end;
            /* gap: 15px; */
            /* flex-wrap: nowrap;
            disables wrapping, rows all in one line */
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            width: 130px;
            height: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;

        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }

        .stat-card.active {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: scale(1.08);
            z-index: 10;
        }

        .stat-card.active:hover {
            transform: scale(1.12);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
        }

        .stat-card.total.active {
            border: 3px solid var(--teal);
            color: white;
        }

        .stat-card.waiting.active {
            border: 3px solid #83792c;
        }

        .stat-card.processing.active {
            border: 3px solid var(--navy);
        }

        .stat-card.rejected.active {
            border: 3px solid #333;
        }


        .stat-card h3 {
            color: #000000;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #2c3e50;
            font-size: 26px;
            font-weight: 700;
        }

        .stat-card.total {
            border: 2px solid var(--navy);
            background-color: var(--sky-blue);
        }

        .stat-card.waiting {
            border: 2px solid #83792c;
            background-color: #f7f5dac2;
        }

        .stat-card.processing {
            border: 2px solid var(--teal);
            background-color: var(--beige);
        }

        .stat-card.rejected {
            border: 2px solid #666;
            background-color: #e0e0e0;
        }

        /* Search and Filters Styling */
        .search-filters-container {
            background: white;
            border-radius: 12px;
            padding: 15px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            /* Reduce space below the search row */
        }

        .search-bar {
            position: relative;
            flex: 1;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(47, 68, 86, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--teal);
            font-size: 14px;
            pointer-events: none;
        }

        .clear-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e0e0e0;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }

        .clear-search:hover {
            background: var(--teal);
            color: white;
        }

        .clear-search.visible {
            display: flex;
        }

        .filters {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input[type="date"] {
            padding: 8px 12px;
            border: 2px solid var(--sky-blue);
            border-radius: 8px;
            font-size: 13px;
            background-color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filters select:focus,
        .filters input[type="date"]:focus {
            outline: none;
            border-color: var(--navy);
            background-color: white;
        }

        .clear-btn {
            padding: 8px 16px;
            background: var(--sky-blue);
            color: var(--navy);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--teal);
            font-size: 13px;
            width: 200px;
        }

        .clear-btn:hover {
            background: var(--navy);
            transform: translateY(-2px);
            color: white;
            border-color: var(--navy);
        }

        @media (max-width: 1200px) {
            .header-row {
                flex-direction: column;
            }

            .stats-container {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .filters select,
            .filters input[type="date"] {
                width: 100%;
            }

            .stats-container {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .account-menu {
            position: absolute;
            top: 40px;
            right: 34px;
            z-index: 1000;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--navy);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 2px solid var(--sky-blue);
        }

        .account-icon:hover {
            background-color: var(--beige);
            border-color: var(--teal);
            transform: scale(1.05);
        }

        .account-icon img {
            width: 50%;
            object-fit: cover;
        }

        .request-link {
            color: var(--navy);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .request-link:hover {
            color: var(--teal);
            text-decoration: underline;
        }

        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--sky-blue);
            background: var(--beige);
        }

        .dropdown-header .admin-name {
            font-weight: 600;
            color: var(--navy);
            font-size: 15px;
        }

        .dropdown-header .admin-email {
            color: var(--teal);
            font-size: 13px;
            margin-top: 4px;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: var(--beige);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--sky-blue);
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: var(--teal);
        }

        .dropdown-item.logout:hover {
            background-color: #e8f4f8;
        }

        #requestModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        /* Modal content - scrolls inside */
        #requestModal>div {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            /* ‚Üê This makes modal scroll */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            margin: auto;
        }

        #requestModal button[onclick*="closeModal"] {
            position: sticky;
            top: -15px;
            z-index: 1;
        }

        /* ‚úÖ PAGINATION STYLES */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e8eef3;
            border-radius: 0 0 12px 12px;
            /* Top flat, bottom rounded */
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            /* Matches table shadow */
        }

        .pagination-info {
            color: var(--navy);
            font-size: 14px;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            background: var(--navy);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            background: var(--teal);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            background: var(--beige);
            color: var(--navy);
            border: 1px solid var(--sky-blue);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 36px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .page-number:hover {
            background: var(--sky-blue);
            border-color: var(--navy);
        }

        .page-number.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
            font-weight: 600;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 2px solid var(--sky-blue);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        .rows-per-page select:focus {
            outline: none;
            border-color: var(--navy);
        }

        @media print {

            /* Hide everything except modal content */
            body * {
                visibility: hidden;
            }


            #modalContent,
            #modalContent * {
                visibility: visible;
            }

            /* Make modal take full page for printing */
            #requestModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white !important;
            }

            #modalContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                max-height: none;
                box-shadow: none;
                padding: 20px;
                overflow: visible;
            }

            /* Hide buttons when printing */
            .no-print {
                display: none !important;
            }

            /* Adjust header padding for print */
            h2 {
                padding-right: 0 !important;
            }
        }

        #EndDateInput:focus {
            border-color: var(--navy) !important;
            box-shadow: 0 0 0 3px rgba(47, 68, 86, 0.1) !important;
        }

        .amount-cell {
            font-weight: 600;
            color: var(--teal);
        }

        .amount-cell.no-amount {
            color: #999;
            font-weight: normal;
        }
    </style>
</head>

<body>
    <header class="admin-header">
        <div class="header-content">
            <div class="header-title">
                <img id="admin-img" src="images/dashboard.png">
                <button onclick="window.location.href='admin-dashboard.html'"
                    style="background: none; border: none; cursor: pointer; padding: 0;">
                    <h1 style="color: white; margin: 0;">Admin Dashboard</h1>
                </button>
            </div>

            <!-- ===== UPDATED: Account menu with dropdown ===== -->
            <div class="account-menu">
                <div class="account-icon" id="accountIcon" onclick="toggleDropdown(event)">
                    <img src="images/user.png" alt="User Account">
                </div>

                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-header">
                        <div class="admin-name" id="adminName">Loading...</div>
                        <div class="admin-email" id="adminEmail">Loading...</div>
                    </div>
                    <a class="dropdown-item" onclick="goToDashboard()" style="cursor: pointer;">
                        <span class="icon">üè†</span> Dashboard
                    </a>
                    <a class="dropdown-item" onclick="window.location.href='my-account.html'" style="cursor: pointer;">
                        <span class="icon">üë§</span> My Account
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item logout" onclick="logout()" style="cursor: pointer;">
                        <span class="icon">üö™</span> Logout
                    </a>
                </div>
            </div>
            <!-- ===== END ===== -->

        </div>
        </div>
    </header>

    <!-- REST OF YOUR HTML CONTINUES HERE... -->
    <div class="requests-table-container">
        <!-- Header row: Search/Filters on left, Stats on right -->
        <div class="header-row">
            <div class="stats-container" id="stats-container">
                <div class="stat-card total" onclick="filterByStatus('')" id="card-total">
                    <h3>Total Requests</h3>
                    <p id="stat-total">0</p>
                </div>
                <div class="stat-card waiting" onclick="filterByStatus('Waiting')" id="card-waiting">
                    <h3>Waiting</h3>
                    <p id="stat-waiting">0</p>
                </div>
                <div class="stat-card processing" onclick="filterByStatus('Processing')" id="card-processing">
                    <h3>Processing</h3>
                    <p id="stat-processing">0</p>
                </div>
                <div class="stat-card rejected" onclick="filterByStatus('Rejected')" id="card-rejected">
                    <h3>rejected</h3>
                    <p id="stat-rejected">0</p>
                </div>
            </div>
            <!-- Search and Filters Section -->
            <div class="search-filters-container">
                <div class="search-row">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Search by Request #, Description, Location...">
                        <button class="clear-search" id="clearSearch" onclick="clearSearchInput()">√ó</button>
                    </div>
                </div>
                <div class="filters">
                    <select id="filterCollege">
                        <option value="">All Colleges</option>
                        <option value="College of Applied Studies">College of Applied Studies</option>
                        <option value="College of Arts">College of Arts</option>
                        <option value="College of Business Adminstration">College of Business Administration</option>
                        <option value="College of Engineering">College of Engineering</option>
                        <option value="College of Health & Sport Sciences">College of Health & Sport Sciences</option>
                        <option value="College of Information Technology">College of Information Technology</option>
                        <option value="College of Law">College of Law</option>
                        <option value="College of Science">College of Science</option>
                        <option value="Alumni Club">Alumni Club</option>
                        <option value="Business Incubator Center">Business Incubator Center</option>
                        <option value="Career Counselling Office">Career Counselling Office</option>
                        <option value="Centre D'√©tudes Fran√ßaises">Centre D'√©tudes Fran√ßaises</option>
                        <option value="Cloud Innovation Center">Cloud Innovation Center</option>
                        <option value="Community Service and Continuing Education Center">Community Service and
                            Continuing
                            Education Center</option>
                        <option value="Confucius Institiute">Confucius Institute</option>
                        <option value="E-Learning Center">E-Learning Center</option>
                        <option value="English Language Center">English Language Center</option>
                        <option value="Information Technology Center">Information Technology Center</option>
                        <option value="Information and Follow-up Office">Information and Follow-up Office</option>
                        <option value="King Sejong Institiute for Teaching Korean">King Sejong Institute for Teaching
                            Korean
                        </option>
                        <option value="Legal Clinic & Human Rights Centre">Legal Clinic & Human Rights Centre</option>
                        <option value="Media Center">Media Center</option>
                        <option value="Quality Assurance and Accrediation Centre">Quality Assurance and Accreditation
                            Centre
                        </option>
                        <option value="Unit for Teaching Excellence and Leadership">Unit for Teaching Excellence and
                            Leadership</option>
                        <option value="Yunus Emre Institiute for Teaching Turkish">Yunus Emre Institute for Teaching
                            Turkish
                        </option>
                    </select>

                    <select id="filterStatus">
                        <option value="">All Status</option>
                        <option value="Waiting">Waiting for Approval</option>
                        <option value="Approved">Approved</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Rejected">Rejected</option>

                    </select>

                    <input type="date" id="filterDateFrom" placeholder="From Date">
                    <input type="date" id="filterDateTo" placeholder="To Date">

                    <button id="clearFilters" class="clear-btn">Clear Filters</button>
                </div>
            </div>
        </div>


        <div class="table-header">
            <h2> Maintenance Requests</h2>
            <button class="download" id="download">
                <img src="images/download-pdf.png" style="width: 26px;height: 26px;">
                <h4>Download</h4>
            </button>
        </div>

        <div class="table-wrapper">
            <div id="loading" class="loading">Loading requests</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="requests-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Request #</th>
                        <th>Status</th>
                        <th>College / Center</th>
                        <th>Department</th>
                        <th>Location</th>
                        <th>Issue Description</th>
                        <th>Date</th>
                        <th>Estimated Cost</th>
                    </tr>
                </thead>
                <tbody id="tickets-tbody">
                </tbody>
            </table>
        </div>
        <!-- ‚úÖ PAGINATION CONTROLS -->
        <div class="pagination-container" id="pagination-container" style="display: none;">
            <div class="pagination-info">
                <span id="pagination-info"></span>
            </div>
            <div class="pagination-controls">
                <div class="rows-per-page">
                    <label>Rows per page:</label>
                    <select id="rowsPerPage" onchange="changeRowsPerPage()">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button class="pagination-btn" id="prevBtn" onclick="prevPage()">‚Üê Previous</button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>
    </div>
    </div>

    <!-- ===== DROPDOWN TOGGLE SCRIPT ===== -->
    <script>
        // Toggle dropdown open/close
        window.toggleDropdown = function (event) {
            event.stopPropagation();
            document.getElementById('dropdownMenu').classList.toggle('active');
        };

        // Close dropdown when clicking anywhere outside
        document.addEventListener('click', function (event) {
            const menu = document.getElementById('dropdownMenu');
            const icon = document.getElementById('accountIcon');
            if (!icon.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // Placeholder logout function ‚Äî wire up to your Firebase auth if needed
        window.logout = function () {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.clear();
                localStorage.clear();
                window.location.replace('login.html');
            }
        };
    </script>

    <!-- Firebase SDKs - YOUR EXISTING FIREBASE CODE -->
    <script type="module">

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';  
        import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCibZPg1QZKtY7g3FHrl5AeZoSFI3xeid0",
            authDomain: "requests-ffdd6.firebaseapp.com",
            databaseURL: "https://requests-ffdd6-default-rtdb.firebaseio.com",
            projectId: "requests-ffdd6",
            storageBucket: "requests-ffdd6.firebasestorage.app",
            messagingSenderId: "316405880275",
            appId: "1:316405880275:web:f4b271583e903ac639cb26",
            measurementId: "G-L0LR313Q4D"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRequestsData = [];
        let jobDescriptionsData = {}; // ‚úÖ NEW - Store job descriptions by request number
        let currentPage = 1;
        let rowsPerPage = 10;
        let filteredRequests = [];



        // ‚úÖ NEW FUNCTION: Load all job descriptions and calculate amounts
        async function loadJobDescriptions() {
            try {
                console.log('üìã Loading Job Descriptions...');

                // Try both possible collection names
                let jobDescSnapshot;
                try {
                    jobDescSnapshot = await getDocs(collection(db, 'JobDescriptions'));
                    console.log('‚úÖ Found JobDescriptions collection');
                } catch (e) {
                    console.log('‚ö†Ô∏è JobDescriptions not found, trying MaterialReport...');
                    jobDescSnapshot = await getDocs(collection(db, 'JobDescriptions'));
                    console.log('‚úÖ Found MaterialReport collection');
                }

                jobDescSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const requestNumber = data.requestNumber || data['Request Number'];

                    console.log('üìÑ Processing document:', {
                        docId: docSnap.id,
                        requestNumber: requestNumber,
                        estimatedTotalCost: data.estimatedTotalCost,
                        totalCost: data.totalCost,
                        laborGrandTotal: data.laborGrandTotal,
                        allFields: Object.keys(data)
                    });

                    if (requestNumber) {
                        // Use estimatedTotalCost (contains materials + labor total)
                        const totalAmount = parseFloat(data.estimatedTotalCost) || 0;
                        jobDescriptionsData[requestNumber] = {
                            totalAmount: totalAmount,
                            estimatedTotalCost: data.estimatedTotalCost || 0,
                            totalCost: data.totalCost || 0,
                            laborGrandTotal: data.laborGrandTotal || 0,
                            materials: data.materials || [],
                            labor: data.labor || [],
                            startingDate: data.startingDate || null,
                            EndDate: data.EndDate || null
                        };

                        console.log(`‚úÖ ${requestNumber}: Total Amount = ${totalAmount.toFixed(2)} BD`);
                    }
                });

                console.log(`‚úÖ Loaded ${Object.keys(jobDescriptionsData).length} Job Descriptions`);
                console.log('üìä Job Descriptions Summary:', Object.keys(jobDescriptionsData).map(key => ({
                    requestNumber: key,
                    amount: jobDescriptionsData[key].totalAmount
                })));
            } catch (error) {
                console.error('‚ùå Error loading Job Descriptions:', error);
                console.error('Error details:', error.message);
            }
        }

        // ‚úÖ FUNCTION: Format amount with currency
        function formatAmount(requestNumber) {
            const jobDesc = jobDescriptionsData[requestNumber];

            if (jobDesc && jobDesc.totalAmount > 0) {
                return `${jobDesc.totalAmount.toFixed(2)} BD`;
            }

            return '-';
        }

        window.printRequestDetails = async function (requestNumber) {
            console.log('üñ®Ô∏è Generating PDF for request:', requestNumber);

            const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
            if (!request) {
                alert('Request not found');
                return;
            }

            // Create a temporary container for the printable content
            const printContainer = document.createElement('div');
            printContainer.style.position = 'absolute';
            printContainer.style.left = '-9999px';
            printContainer.style.width = '800px';
            printContainer.style.background = 'white';
            printContainer.style.padding = '40px';
            printContainer.style.fontFamily = 'Cairo, Amiri, Arial, sans-serif';

            // Build the HTML content with proper Arabic support
            const status = request.Status || 'Waiting';
            const statusCheck = status.toLowerCase();
            const showCompletedDates = statusCheck === 'completed';
            const showApprovedSection = statusCheck === 'approved' || statusCheck.includes('approved');
            const showRejectedSection = statusCheck === 'rejected' || statusCheck.includes('reject');
            const showProcessingSection = statusCheck === 'processing' || statusCheck.includes('progress');

            printContainer.innerHTML = `
        <div style="direction: ltr; text-align: left;">
            <!-- Header -->
            <div style="background: var(--navy); color: white; padding: 30px; text-align: center; margin-bottom: 30px; border-radius: 10px;">
    <h1 style="margin: 0 0 10px 0; font-size: 28px;">Request Details</h1>
    <p style="margin: 0; font-size: 16px;">Request #: ${request['Request Number']}</p>
</div>

            <!-- Basic Information with Status Badge -->
            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                <!-- ‚úÖ Header row with Status Badge -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--navy);">
                    <h2 style="color:var(--navy); margin: 0; font-size: 18px;">Basic Information</h2>
                    <!-- ‚úÖ Status Badge moved here -->
                    <span style="
                        display: inline-block;
                        padding: 6px 18px;
                        border-radius: 20px;
                        font-weight: bold;
                        font-size: 13px;
                        ${statusCheck.includes('waiting') ? 'background: #f4d4d4; color: #e64d4d;' : ''}
                        ${statusCheck.includes('approved') ? 'background: #C8D9E6; color: #567C8D;' : ''}
                        ${statusCheck.includes('processing') || statusCheck.includes('progress') ? 'background: #C8D9E6; color: #2F4456;' : ''}
                        ${statusCheck.includes('completed') ? 'background: #F5EFEB; color: #2F4456; border: 1px solid #567C8D;' : ''}
                        ${statusCheck.includes('rejected') ? 'background: #e0e0e0; color: #666;' : ''}
                    ">${status}</span>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666; width: 40%;">Date Submitted:</td>
                        <td style="padding: 10px 0; color: #000;">${formatDate(request['Request Date'] || request.Date)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666;">Submitted by:</td>
                        <td style="padding: 10px 0; color: #000; direction: rtl; text-align: left;">${request['Name'] || request['Submitted by'] || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666;">College:</td>
                        <td style="padding: 10px 0; color: #000;">${mapCollegeName(request.College) || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666;">Department:</td>
                        <td style="padding: 10px 0; color: #000;">${request.Department || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666;">Location:</td>
                        <td style="padding: 10px 0; color: #000;">${request.Location || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px 0; font-weight: bold; color: #666;">Mobile:</td>
                        <td style="padding: 10px 0; color: #000;">${request['Mobile Number'] || 'N/A'}</td>
                    </tr>
                </table>
            </div>

            <!-- Issue Description -->
            <div style="background: #f5f5f5; padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #666; margin: 0 0 15px 0; font-size: 16px;">Issue Description:</h3>
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    direction: rtl;
                    text-align: left;
                    font-family: 'Cairo', 'Amiri', Arial, sans-serif;
                    line-height: 1.8;
                    color: #000;
                ">${request.Description || 'N/A'}</div>
            </div>

            ${showCompletedDates ? `
                <p style="margin: 0 0 8px 0; font-size: 14px;">
                    <strong style="color: #666;margin-left:20px;font-size:15px;">Start Date:</strong> 
                    <span style="color: #1565C0; font-weight: bold;font-size:15px;margin-left:7px;">${getJobDescDate(request['Request Number'], 'startingDate')}</span>
                </p>
                
                <p style="margin: 0; font-size: 14px;">
                    <strong style="color: #666;margin-left:20px;font-size:15px;">End Date:</strong> 
                    <span style="color: #1565C0; font-weight: bold;font-size:15px;margin-left:7px;">${getJobDescDate(request['Request Number'], 'EndDate')}</span>
                </p>
            ` : ''}

            ${showApprovedSection ? `
            <div style="background: #FFF3E0; border: 2px solid #FF9800; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                <h3 style="color: #E65100; margin: 0 0 15px 0; font-size: 18px;">‚úì Request Approved</h3>
                ${request['Approved Date'] ? `
                <p style="margin: 0;"><strong style="color: #666;">Approved On:</strong> <span style="color: #E65100;">${formatDate(request['Approved Date'])}</span></p>
                ` : ''}
            </div>
            ` : ''}

            ${showRejectedSection ? `
            <div style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                <h3 style="color: #C62828; margin: 0 0 15px 0; font-size: 18px;">‚úó Request Rejected</h3>
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: bold; color: #666; margin-bottom: 8px;">Reason for Rejection:</p>
                    <div style="
                        background: #FFCDD2;
                        padding: 15px;
                        border-radius: 6px;
                        direction: rtl;
                        text-align: right;
                        color: #C62828;
                        font-family: 'Cairo', 'Amiri', Arial, sans-serif;
                    ">${request['Rejection Reason'] || request['rejectionReason'] || 'No reason provided'}</div>
                </div>
                ${request['Rejected Date'] || request['rejectedDate'] ? `
                <p style="margin: 10px 0 0 0;"><strong style="color: #666;">Rejected On:</strong> <span style="color: #C62828;">${formatDate(request['Rejected Date'] || request['rejectedDate'])}</span></p>
                ` : ''}
            </div>
            ` : ''}

            ${showProcessingSection ? `
            <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                <h3 style="color: #2E7D32; margin: 0 0 20px 0; font-size: 18px;">‚è≥ Request in Processing</h3>
                ${request['StartDate'] ? `
                <p style="margin: 0 0 10px 0;"><strong style="color: #666;">Start Date:</strong> <span style="color: #2E7D32;">${formatDateOnly(request['StartDate'])}</span></p>
                ` : ''}
                ${request['End Date'] ? `
                <p style="margin: 0;"><strong style="color: #666;">Expected End Date:</strong> <span style="color: #2E7D32;">${formatDateOnly(request['End Date'])}</span></p>
                ` : ''}
            </div>
            ` : ''}

            <!-- Footer -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #999; font-size: 12px;">
                <p style="margin: 0;">Generated on: ${new Date().toLocaleString()}</p>
            </div>
        </div>
    `;

            document.body.appendChild(printContainer);

            // Wait for fonts to load
            await document.fonts.ready;

            try {
                // Convert HTML to canvas
                const canvas = await html2canvas(printContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Remove temporary container
                document.body.removeChild(printContainer);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');

                const pdfWidth = 210; // A4 width in mm
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                const doc = new jsPDF('p', 'mm', 'a4');

                let heightLeft = pdfHeight;
                let position = 0;

                // Add first page
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= 297; // A4 height

                // Add more pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= 297;
                }

                // Open print dialog
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);

                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'fixed';
                printFrame.style.right = '0';
                printFrame.style.bottom = '0';
                printFrame.style.width = '0';
                printFrame.style.height = '0';
                printFrame.style.border = 'none';

                document.body.appendChild(printFrame);

                printFrame.src = pdfUrl;
                printFrame.onload = function () {
                    try {
                        const printWindow = window.open(pdfUrl, '_blank');
                        printWindow.print(); setTimeout(() => {
                            document.body.removeChild(printFrame);
                            URL.revokeObjectURL(pdfUrl);
                            console.log('‚úÖ Print dialog closed');
                        }, 1000);
                    } catch (error) {
                        console.error('‚ùå Print error:', error);
                        alert('Could not open print dialog. Please allow pop-ups for this site.');
                        document.body.removeChild(printFrame);
                        URL.revokeObjectURL(pdfUrl);
                    }
                };

            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF: ' + error.message);
                if (printContainer.parentNode) {
                    document.body.removeChild(printContainer);
                }
            }
        };

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            try {
                if (dateValue.toDate) {
                    const date = dateValue.toDate();
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',

                    });
                }
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                    return dateValue;
                }
                if (dateValue instanceof Date) {
                    return dateValue.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                    });
                }
            } catch (error) {
                console.error('Error formatting date:', error);
            }
            return 'N/A';
        }

        function getJobDescDate(requestNumber, fieldName) {
            console.log('üîç getJobDescDate called:', { requestNumber, fieldName });
            const jobDesc = jobDescriptionsData[requestNumber];
            console.log('üì¶ Job Description found:', jobDesc);

            if (jobDesc && jobDesc[fieldName]) {
                console.log(`‚úÖ ${fieldName} value:`, jobDesc[fieldName]);
                return formatDateOnly(jobDesc[fieldName]);
            }

            console.warn(`‚ö†Ô∏è No ${fieldName} found for ${requestNumber}`);
            return 'N/A';
        }

        function formatDateOnly(dateValue) {
            if (!dateValue) return 'N/A';
            try {
                if (dateValue.toDate) {
                    const date = dateValue.toDate();
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                    return dateValue;
                }
                if (dateValue instanceof Date) {
                    return dateValue.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                console.error('Error formatting date:', error);
            }
            return 'N/A';
        }

        function getStatusClass(status) {
            const statusLower = (status || '').toLowerCase();
            if (statusLower.includes('progress') || statusLower.includes('processing')) return 'status-processing';
            if (statusLower.includes('waiting')) return 'status-waiting';
            if (statusLower.includes('approved')) return 'status-Approved';
            if (statusLower.includes('completed')) return 'status-Completed';
            if (statusLower.includes('rejected')) return 'status-rejected';
            return 'status-waiting';
        }

        function formatStatus(status) {
            if (!status) return 'Waiting';
            return status;
        }

        function mapCollegeName(oldName) {
            const collegeMapping = {
                'Applied': 'College of Applied Studies',
                'Arts': 'College of Arts',
                'Business': 'College of Business Adminstration',
                'Engineering': 'College of Engineering',
                'Health': 'College of Health & Sport Sciences',
                'IT': 'College of Information Technology',
                'Law': 'College of Law',
                'Science': 'College of Science',
                'Alumni': 'Alumni Club',
                'BIC': 'Business Incubator Center',
                'Counselling': 'Career Counselling Office',
                'French': 'Centre D\'√©tudes Fran√ßaises',
                'Cloud': 'Cloud Innovation Center',
                'CI': 'Confucius Institiute',
                'E-Learning': 'E-Learning Center',
                'English': 'English Language Center',
                'ITC': 'Information Technology Center',
                'Follow-up': 'Information and Follow-up Office',
                'Korean': 'King Sejong Institiute for Teaching Korean',
                'Legal': 'Legal Clinic & Human Rights Centre',
                'Media': 'Media Center',
                'QA': 'Quality Assurance and Accrediation Centre',
                'Teaching': 'Unit for Teaching Excellence and Leadership',
                'Turkish': 'Yunus Emre Institiute for Teaching Turkish'
            };
            return collegeMapping[oldName] || oldName;
        }

        function updateStats(requests) {
            const stats = {
                total: requests.length,
                waiting: 0,
                inProgress: 0,
                rejected: 0
            };

            requests.forEach(req => {
                const status = (req.Status || '').toLowerCase();
                if (status.includes('progress') || status.includes('processing')) {
                    stats.inProgress++;
                } else if (status.includes('waiting') || status.includes('pending')) {
                    stats.waiting++;
                } else if (status.includes('rejected')) {
                    stats.rejected++;
                }
            });

            const totalElement = document.getElementById('stat-total');
            const waitingElement = document.getElementById('stat-waiting');
            const processingElement = document.getElementById('stat-processing');
            const rejectedElement = document.getElementById('stat-rejected');

            if (totalElement) totalElement.textContent = stats.total;
            if (waitingElement) waitingElement.textContent = stats.waiting;
            if (processingElement) processingElement.textContent = stats.inProgress;
            if (rejectedElement) rejectedElement.textContent = stats.rejected;
        }

        // ‚úÖ FIXED FILTER FUNCTION
        function filterAndDisplayRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const filterCollege = document.getElementById('filterCollege').value.trim();
            const filterStatus = document.getElementById('filterStatus').value.trim();
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;

            console.log('üîç FILTERING WITH:');
            console.log('Search:', searchTerm);
            console.log('College:', filterCollege);
            console.log('Status:', filterStatus);
            console.log('Date From:', filterDateFrom);
            console.log('Date To:', filterDateTo);

            const clearSearchBtn = document.getElementById('clearSearch');
            if (searchTerm) {
                clearSearchBtn.classList.add('visible');
            } else {
                clearSearchBtn.classList.remove('visible');
            }

            const tbody = document.getElementById("tickets-tbody");
            const table = document.getElementById("requests-table");
            tbody.innerHTML = "";

            filteredRequests = allRequestsData.filter(data => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (data['Request Number'] || '').toLowerCase().includes(searchTerm) ||
                    (data.Description || '').toLowerCase().includes(searchTerm) ||
                    (data.Location || '').toLowerCase().includes(searchTerm) ||
                    (data.College || '').toLowerCase().includes(searchTerm) ||
                    (data.Department || '').toLowerCase().includes(searchTerm);

                // College filter
                const matchesCollege = !filterCollege || mapCollegeName(data.College) === filterCollege;

                // ‚úÖ FIXED STATUS FILTER - handles all variations
                let matchesStatus = true;
                if (filterStatus) {
                    const dataStatus = (data.Status || data.status || 'waiting').toLowerCase().trim();
                    const filterStatusLower = filterStatus.toLowerCase();

                    if (filterStatusLower === 'waiting' || filterStatusLower === 'waiting for approval') {
                        matchesStatus = dataStatus.includes('waiting');
                    } else if (filterStatusLower === 'approved') {
                        matchesStatus = dataStatus.includes('approved');
                    } else if (filterStatusLower === 'processing') {
                        matchesStatus = dataStatus.includes('processing') || dataStatus.includes('progress');
                    } else if (filterStatusLower === 'completed') {
                        matchesStatus = dataStatus.includes('completed') || dataStatus.includes('done');
                    } else if (filterStatusLower === 'rejected') {
                        matchesStatus = dataStatus.includes('rejected') || dataStatus.includes('reject');
                    } else {
                        matchesStatus = dataStatus === filterStatusLower;
                    }
                }

                // ‚úÖ FIXED DATE FILTER
                let matchesDate = true;
                if (filterDateFrom || filterDateTo) {
                    let requestDate;
                    if (data['Request Date']?.toDate) {
                        requestDate = data['Request Date'].toDate();
                    } else if (data.Date?.toDate) {
                        requestDate = data.Date.toDate();
                    } else {
                        requestDate = new Date(data['Request Date'] || data.Date);
                    }

                    requestDate.setHours(0, 0, 0, 0);

                    if (filterDateFrom) {
                        const fromDate = new Date(filterDateFrom);
                        fromDate.setHours(0, 0, 0, 0);
                        if (requestDate < fromDate) matchesDate = false;
                    }

                    if (filterDateTo) {
                        const toDate = new Date(filterDateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (requestDate > toDate) matchesDate = false;
                    }
                }

                return matchesSearch && matchesCollege && matchesStatus && matchesDate;
            });

            console.log('‚úÖ Filtered:', filteredRequests.length, 'requests');

            if (filteredRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No requests match your filters</td></tr>';
                table.style.display = "table";
                document.getElementById('pagination-container').style.display = 'none';
                updateStats(filteredRequests);
                return;
            }

            // Validate current page
            const totalPages = Math.ceil(filteredRequests.length / rowsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            paginatedRequests.forEach((data) => {
                const status = formatStatus(data.Status);
                const statusClass = getStatusClass(status);
                // ‚úÖ FIXED: Use data['Request Number']
                const amount = formatAmount(data['Request Number']);
                const modalHTML = `
                    <div id="requestModal" ...>
                    <div id="modalContent" ...>
                        ...
            
            ${amount !== '-' ? `
                    <div style="background: #E8F5E9; border: 2px solid #4CAF50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <p style="font-weight: 600; color: #2E7D32; margin-bottom: 5px;">Total Amount:</p>
                    <p style="color: #2E7D32; font-size: 24px; font-weight: bold;">${amount}</p>
                    </div>
                    ` : ''}
            
                    ...
        </div>
    </div>
`;
                const amountClass = amount === '-' ? 'amount-cell no-amount' : 'amount-cell'; // ‚úÖ NEW

                const row = document.createElement("tr");
                row.innerHTML = `
        <td><a href="#" class="request-link" onclick="viewRequestDetails('${data['Request Number']}'); return false;">${data['Request Number'] || 'N/A'}</a></td>
        <td><span class="${statusClass}">${status}</span></td>
        <td>${mapCollegeName(data.College) || 'N/A'}</td>
        <td>${data.Department || 'N/A'}</td>
        <td>${data.Location || 'N/A'}</td>
        <td>${data.Description || data.Issue || 'N/A'}</td>
        <td>${formatDate(data['Request Date'] || data['Date'])}</td>
        <td class="${amountClass}">${amount}</td>  <!-- ‚úÖ NEW COLUMN -->
    `;
                tbody.appendChild(row);
            });

            table.style.display = "table";
            updateStats(filteredRequests);
            updatePaginationUI(totalPages, startIndex, endIndex);
        }

        function updatePaginationUI(totalPages, startIndex, endIndex) {
            const paginationContainer = document.getElementById('pagination-container');
            const paginationInfo = document.getElementById('pagination-info');
            const pageNumbers = document.getElementById('pageNumbers');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (filteredRequests.length === 0) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';
            const showing = Math.min(endIndex, filteredRequests.length);
            paginationInfo.textContent = `Showing ${startIndex + 1}-${showing} of ${filteredRequests.length} requests`;

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstPage = document.createElement('button');
                firstPage.className = 'page-number';
                firstPage.textContent = '1';
                firstPage.onclick = () => goToPage(1);
                pageNumbers.appendChild(firstPage);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    ellipsis.style.color = '#666';
                    pageNumbers.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    ellipsis.style.color = '#666';
                    pageNumbers.appendChild(ellipsis);
                }

                const lastPage = document.createElement('button');
                lastPage.className = 'page-number';
                lastPage.textContent = totalPages;
                lastPage.onclick = () => goToPage(totalPages);
                pageNumbers.appendChild(lastPage);
            }
        }



        window.goToPage = function (page) {
            currentPage = page;
            filterAndDisplayRequests();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.nextPage = function () {
            if (currentPage < Math.ceil(filteredRequests.length / rowsPerPage)) {
                currentPage++;
                filterAndDisplayRequests();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.prevPage = function () {
            if (currentPage > 1) {
                currentPage--;
                filterAndDisplayRequests();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.changeRowsPerPage = function () {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            filterAndDisplayRequests();
        };

        async function loadRequests() {
            const tbody = document.getElementById("tickets-tbody");
            const loadingDiv = document.getElementById("loading");
            const errorDiv = document.getElementById("error");
            const table = document.getElementById("requests-table");

            try {
                tbody.innerHTML = "";
                loadingDiv.style.display = "block";
                errorDiv.style.display = "none";
                table.style.display = "none";

                // ‚úÖ Load job descriptions first
                await loadJobDescriptions();

                const requestsSnapshot = await getDocs(collection(db, "Requests"));
                loadingDiv.style.display = "none";

                if (requestsSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No requests found</td></tr>';
                    table.style.display = "table";
                    return;
                }

                allRequestsData = [];
                requestsSnapshot.forEach((docSnap) => {
                    allRequestsData.push(docSnap.data());
                });

                allRequestsData.sort((a, b) => {
                    const dateA = a['Request Date']?.toDate?.() || a.Date?.toDate?.() || new Date(a['Request Date'] || a.Date || 0);
                    const dateB = b['Request Date']?.toDate?.() || b.Date?.toDate?.() || new Date(b['Request Date'] || b.Date || 0);
                    return dateB - dateA;
                });

                console.log('‚úÖ Loaded', allRequestsData.length, 'requests');

                // ‚úÖ CHECK FOR URL PARAMETERS
                const urlParams = new URLSearchParams(window.location.search);
                const statusParam = urlParams.get('status');
                const dateFromParam = urlParams.get('dateFrom');
                const dateToParam = urlParams.get('dateTo');

                if (statusParam) {
                    console.log('üìå Applying URL status filter:', statusParam);
                    const capitalizedStatus = statusParam.charAt(0).toUpperCase() + statusParam.slice(1);
                    document.getElementById('filterStatus').value = capitalizedStatus;
                }

                if (dateFromParam) {
                    console.log('üìå Applying URL date from:', dateFromParam);
                    document.getElementById('filterDateFrom').value = dateFromParam;
                }

                if (dateToParam) {
                    console.log('üìå Applying URL date to:', dateToParam);
                    document.getElementById('filterDateTo').value = dateToParam;
                }

                filterAndDisplayRequests();

            } catch (error) {
                console.error("Error loading requests:", error);
                loadingDiv.style.display = "none";
                errorDiv.textContent = `Error loading requests: ${error.message}`;
                errorDiv.style.display = "block";
            }
        }

        // Load admin profile information
        async function loadAdminProfile() {
            try {
                const userEmail = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
                const userName = sessionStorage.getItem('userName') || localStorage.getItem('userName');

                // Update dropdown header
                const adminNameEl = document.getElementById('adminName');
                const adminEmailEl = document.getElementById('adminEmail');

                if (adminNameEl && userName) {
                    adminNameEl.textContent = userName;
                }

                if (adminEmailEl && userEmail) {
                    adminEmailEl.textContent = userEmail;
                }

                console.log('‚úÖ Admin profile loaded:', { userName, userEmail });
            } catch (error) {
                console.error('‚ùå Error loading admin profile:', error);
            }
        }

        // Call this function when page loads
        loadAdminProfile();

        window.closeModal = function () {
            const modal = document.getElementById('requestModal');
            if (modal) {
                modal.remove();
            }
            document.body.classList.remove('modal-open');
        };

        window.viewRequestDetails = function (requestNumber) {
            const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
            if (!request) {
                alert('Request not found');
                return;
            }

            const status = (request.Status || 'Waiting').toLowerCase();
            const showCompletedDates = status === 'completed';
            const showApprovedSection = status === 'approved' || status.includes('approved');
            const showRejectedSection = status === 'rejected' || status.includes('reject');
            const showProcessingSection = status === 'processing' || status.includes('progress');

            const modalHTML = `
    <div id="requestModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div id="modalContent" style="background: white; border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); position: relative;">
            <div class="no-print" style="position: absolute; top: 15px; right: 30px; display: flex; gap: 10px; align-items: center;">
    
    
    <!-- Print PDF Button (Circle) -->
<button onclick="printRequestDetails('${request['Request Number']}')" 
        style="background: var(--navy); 
               color: white; 
               border: none; 
               width: 45px; 
               height: 45px; 
               border-radius: 50%; 
               font-size: 20px; 
               cursor: pointer; 
               transition: all 0.3s ease; 
               display: flex; 
               align-items: center; 
               justify-content: center;
               box-shadow: 0 2px 8px rgba(47, 68, 86, 0.3);" 
        onmouseover="this.style.background='var(--teal)'" 
        onmouseout="this.style.background='var(--navy)'"
        title="Print PDF">
    <img src="images/printer.png" style="width:25px;height:25px">
</button>

<!-- View Job Button (Circle) -->
<button onclick="viewMaterialReport('${request['Request Number']}')" 
        style="background: var(--teal); 
               color: white; 
               border: none; 
               width: 45px; 
               height: 45px; 
               border-radius: 50%; 
               font-size: 20px; 
               cursor: pointer; 
               transition: all 0.3s ease; 
               display: flex; 
               align-items: center; 
               justify-content: center;
               box-shadow: 0 2px 8px rgba(86, 124, 141, 0.3);" 
        onmouseover="this.style.background='var(--navy)'" 
        onmouseout="this.style.background='var(--teal)'"
        title="View Job Description">
    <img src="images/file.png" style="width:25px;height:25px">
</button>
    <!-- Close Button (Circle) -->
    <button onclick="closeModal()" 
        style="background: #e0e0e0; 
               color: #333; 
               border: none; 
               width: 45px; 
               height: 45px; 
               border-radius: 50%; 
               font-size: 22px; 
               cursor: pointer; 
               transition: all 0.3s ease; 
               display: flex; 
               align-items: center; 
               justify-content: center; 
               padding: 0;
               box-shadow: 0 2px 8px rgba(0,0,0,0.15);" 
        onmouseover="this.style.background='var(--teal)'; this.style.color='white'; this.style.transform='scale(1.1)'" 
        onmouseout="this.style.background='#e0e0e0'; this.style.color='#333'; this.style.transform='scale(1)'">
    √ó
</button>
</div>

<h2 style="color: var(--navy); margin-bottom: 20px; font-size: 24px; border-bottom: 2px solid var(--navy); padding-bottom: 10px; padding-right: 120px;">Request Details</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Date Submitted:</p>
                        <p style="color: #2c3e50;">${formatDate(request['Request Date'] || request.Date)}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Submitted by:</p>
                        <p style="color: #2c3e50;">${request['Name'] || request['Submitted by'] || 'N/A'}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">College:</p>
                        <p style="color: #2c3e50;">${mapCollegeName(request.College) || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Department:</p>
                        <p style="color: #2c3e50;">${request.Department || 'N/A'}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Location:</p>
                        <p style="color: #2c3e50;">${request.Location || 'N/A'}</p>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Mobile:</p>
                        <p style="color: #2c3e50;">${request['Mobile Number'] || 'N/A'}</p>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Issue Description:</p>
                    <p style="color: #2c3e50; background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">${request.Description || 'N/A'}</p>
                </div>

                ${showCompletedDates ? `
                    <div style="background: var(--sky-blue); border: 2px solid var(--navy); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: var(--navy); margin-bottom: 15px; font-size: 18px;">‚úÖ Request Completed</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Start Date:</p>
                            <p style="color: #1565C0; font-weight: 600; font-size: 16px;">${getJobDescDate(request['Request Number'], 'startingDate')}</p>
                        </div>
                        <div>
                            <p style="font-weight: 600; color: #666; margin-bottom: 5px;">End Date:</p>
                            <p style="color: #1565C0; font-weight: 600; font-size: 16px;">${getJobDescDate(request['Request Number'], 'EndDate')}</p>
                        </div>
                    </div>
                    </div>
                ` : ''}

                ${showApprovedSection ? `
                <div style="background: #e8f4f8; border: 2px solid var(--teal); border-radius: 10px; padding: 20px; margin-bottom: 20px;font-family:serif;">
                    <h3 style="color: var(--teal); margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                        <img src="images/contract.png" style="width:25px;height:25px;margin-right:5px;"> Assign Materials & Labor
                    </h3>
                    
                    <button onclick="checkAndRedirectToMaterialReport('${request['Request Number']}')" 
                            style="background: var(--teal); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 50%; transition: all 0.3s ease;" 
                            onmouseover="this.style.background='var(--navy)'" 
                            onmouseout="this.style.background='var(--teal)'">
                        Create Job Description
                    </button>
                </div>
                                    

                ${request['Approved Date'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #FFE0B2;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Approved On:</p>
                        <p style="color: #E65100; font-size: 14px;">${formatDate(request['Approved Date'])}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                ${showRejectedSection ? `
                <div style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #C62828; margin-bottom: 15px; font-size: 18px;">‚ùå Request Rejected</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 8px;">Reason for Rejection:</p>
                        <p style="color: #C62828; background: #FFCDD2; padding: 12px; border-radius: 6px; line-height: 1.6; white-space: pre-wrap;">${request['Rejection Reason'] || request['rejectionReason'] || 'No reason provided'}</p>
                    </div>

                    ${request['Rejected Date'] || request['rejectedDate'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #FFCDD2;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Rejected On:</p>
                        <p style="color: #C62828; font-size: 14px;">${formatDate(request['Rejected Date'] || request['rejectedDate'])}</p>
                    </div>
                    ` : ''}

                    ${request['Rejected By'] || request['rejectedBy'] ? `
                    <div style="margin-top: 10px;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Rejected By:</p>
                        <p style="color: #C62828; font-size: 14px;">${request['Rejected By'] || request['rejectedBy']}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                ${showProcessingSection ? `
                <div style="background: #e8f4f8; border: 2px solid var(--navy); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
    <h3 style="color: var(--navy); margin-bottom: 15px; font-size: 18px;">üìÖ Set Completion Date</h3>
    
    <button onclick="saveEndDate('${request['Request Number']}')" 
            style="background: var(--navy); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease;" 
            onmouseover="this.style.background='var(--teal)'" 
            onmouseout="this.style.background='var(--navy)'">
        Save End Date & Complete
    </button>
</div>
                    ${request['End Date'] ? `<p style="margin-top: 15px; color: #2E7D32; font-size: 14px; text-align: center;">‚úì Current end date: ${formatDateOnly(request['End Date'])}</p>` : ''}

                    ${request['StartDate'] ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #C8E6C9;">
                        <p style="font-weight: 600; color: #666; margin-bottom: 5px;">Start Date:</p>
                        <p style="color: #2E7D32; font-size: 14px;">${formatDateOnly(request['StartDate'])}</p>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
        </div>
    `;

            const existingModal = document.getElementById('requestModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.classList.add('modal-open');
        };

        // ‚úÖ ADD THIS NEW FUNCTION for redirecting to job description
        window.redirectToMaterialReport = function (requestNumber) {
            // Store request number in session storage
            sessionStorage.setItem('selectedRequestNumber', requestNumber);

            // Close modal
            closeModal();

            // Redirect to job description page
            window.location.href = 'material-report.html?request=' + requestNumber;
        };
        window.viewMaterialReport = async function (requestNumber) {
            console.log('üìã Fetching Job Description for:', requestNumber);

            try {
                // Fetch Job Description from Firebase
                const jobDescRef = collection(db, 'JobDescriptions');
                const jobDescSnapshot = await getDocs(jobDescRef);

                let jobDescData = null;
                let jobDescId = null;

                // Search for matching Job Description
                jobDescSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();

                    // ‚úÖ Check BOTH possible field name variations
                    const docRequestNum = data.requestNumber || data['Request Number'];

                    console.log(`Checking Job Desc ${docSnap.id.substring(0, 8)}: requestNumber = "${docRequestNum}"`);

                    if (docRequestNum === requestNumber) {
                        jobDescData = data;
                        jobDescId = docSnap.id;
                        console.log('‚úÖ MATCH FOUND!');
                    }
                });

                // ‚ùå No Job Description found
                if (!jobDescData) {
                    console.log('‚ùå No Job Description found for:', requestNumber);
                    alert('‚ùå No Job Description Found\n\nThis request does not have materials and labor assigned yet.');
                    return;
                }

                // ‚úÖ Job Description found!
                console.log('‚úÖ Job Description found:', jobDescData);
                console.log('Document ID:', jobDescId);

                // Store data in localStorage for the Job Description page
                localStorage.setItem('selectedRequestNumber', requestNumber);
                localStorage.setItem('jobDescriptionData', JSON.stringify(jobDescData));
                localStorage.setItem('jobDescriptionId', jobDescId);
                localStorage.setItem('viewMode', 'view');

                // Also store the original request data
                const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
                if (request) {
                    localStorage.setItem('selectedRequestData', JSON.stringify(request));
                }

                // Close modal
                closeModal();

                // Redirect to Job Description page
                console.log('üîÑ Redirecting to material-report.html...');
                window.location.href = 'material-report.html?request=' + requestNumber + '&mode=view';

            } catch (error) {
                console.error('‚ùå Error fetching Job Description:', error);
                console.error('Full error:', error.stack);
                alert('Error loading Job Description:\n\n' + error.message + '\n\nPlease check the console for details.');
            }
        };
        // Add this function in your Firebase script section (after the viewMaterialReport function)

        window.checkAndRedirectToMaterialReport = async function (requestNumber) {
            console.log('üîç Checking for existing Job Description for:', requestNumber);

            try {
                // Check if Job Description already exists
                const jobDescRef = collection(db, 'JobDescriptions');
                const jobDescSnapshot = await getDocs(jobDescRef);

                let jobDescExists = false;
                let existingJobDescId = null;

                jobDescSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docRequestNum = data.requestNumber || data['Request Number'];

                    if (docRequestNum === requestNumber) {
                        jobDescExists = true;
                        existingJobDescId = docSnap.id;
                    }
                });

                if (jobDescExists) {
                    // Job Description already exists - ask user what they want to do
                    const userChoice = confirm(
                        '‚ö†Ô∏è A Job Description already exists for this request.\n\n' +
                        'Click OK to VIEW the existing Job Description\n' +
                        'Click Cancel to stay on this page'
                    );

                    if (userChoice) {
                        // User wants to view existing Job Description
                        viewMaterialReport(requestNumber);
                    }
                    return;
                }

                // No Job Description exists - proceed to create new one
                console.log('‚úÖ No existing Job Description found. Redirecting to create new one...');

                // Get the request data
                const request = allRequestsData.find(req => req['Request Number'] === requestNumber);

                if (!request) {
                    alert('‚ùå Error: Request data not found');
                    return;
                }

                // Store request data in sessionStorage for the Job Description form
                const formData = {
                    requestNumber: request['Request Number'],
                    location: request.Location || '',
                    college: mapCollegeName(request.College) || '',
                    department: request.Department || '',
                    description: request.Description || ''
                };

                sessionStorage.setItem('maintenanceFormData', JSON.stringify(formData));

                console.log('üì¶ Stored form data:', formData);

                // Close modal
                closeModal();

                // Redirect to Job Description page
                window.location.href = 'material-report.html?request=' + requestNumber + '&mode=create';

            } catch (error) {
                console.error('‚ùå Error checking Job Description:', error);
                alert('Error: ' + error.message);
            }
        };

        // ‚úÖ ENHANCED saveEndDate function with validation
        window.saveEndDate = async function (requestNumber) {
            const EndDateInput = document.getElementById('EndDateInput');
            const EndDate = EndDateInput?.value;

            if (!EndDate) {
                alert('Please select an end date');
                return;
            }

            const selectedDate = new Date(EndDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);

            // ‚úÖ VALIDATION: End date must be today or in the past
            if (selectedDate > today) {
                alert('‚ùå End date cannot be in the future! Please select today or an earlier date.');
                return;
            }

            const shouldComplete = selectedDate <= today;
            const newStatus = shouldComplete ? 'Completed' : 'Processing';

            const message = shouldComplete
                ? 'This date is today or in the past. The request status will be changed to "Completed". Continue?'
                : 'Save this end date for the request?';

            if (!confirm(message)) return;

            try {
                const requestsRef = collection(db, 'JobDescription');
                const querySnapshot = await getDocs(requestsRef);

                let docId = null;
                querySnapshot.forEach((docSnap) => {
                    if (docSnap.data()['Request Number'] === requestNumber) {
                        docId = docSnap.id;
                    }
                });

                if (docId) {
                    const updateData = {
                        'End Date': EndDate,
                        'End Date Updated': serverTimestamp()
                    };

                    if (shouldComplete) {
                        updateData['Status'] = 'Completed';
                        updateData['Completed Date'] = serverTimestamp();
                    }

                    await updateDoc(doc(db, 'JobDescription', docId), updateData);

                    const successMessage = shouldComplete
                        ? 'End date saved successfully! Request status changed to Completed.'
                        : 'End date saved successfully!';

                    alert(successMessage);

                    const request = allRequestsData.find(req => req['Request Number'] === requestNumber);
                    if (request) {
                        request['End Date'] = EndDate;
                        if (shouldComplete) request['Status'] = 'Completed';
                    }

                    await loadRequests();
                    closeModal();

                    if (!shouldComplete) {
                        setTimeout(() => viewRequestDetails(requestNumber), 500);
                    }

                } else {
                    alert('Error: Request not found in database');
                }

            } catch (error) {
                console.error('Error saving end date:', error);
                alert('Error: ' + error.message);
            }
        };

        // ‚úÖ FIXED FILTER BY STATUS
        window.filterByStatus = function (status) {
            console.log('üéØ filterByStatus called with:', status);
            document.getElementById('filterStatus').value = status;

            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));

            if (status === '') {
                document.getElementById('card-total').classList.add('active');
            } else if (status.toLowerCase() === 'waiting') {
                document.getElementById('card-waiting').classList.add('active');
            } else if (status.toLowerCase() === 'processing') {
                document.getElementById('card-processing').classList.add('active');
            } else if (status.toLowerCase() === 'rejected') {
                document.getElementById('card-rejected').classList.add('active');
            }

            filterAndDisplayRequests();
        };

        window.clearSearchInput = function () {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.remove('visible');
            filterAndDisplayRequests();
        };

        // ‚úÖ EVENT LISTENERS
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterCollege').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterStatus').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterDateFrom').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });
        document.getElementById('filterDateTo').addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayRequests();
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterCollege').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('clearSearch').classList.remove('visible');

            // Remove active state from all stat cards
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            document.getElementById('card-total').classList.add('active');

            filterAndDisplayRequests();
        });

        loadRequests();
        loadAdminProfile();
        setInterval(loadRequests, 100000);

        document.getElementById('download').addEventListener('click', async function () {
            console.log('üì• Download PDF button clicked - Optimized Version');

            if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                alert('PDF library not loaded. Please refresh the page.');
                return;
            }

            if (filteredRequests.length === 0) {
                alert('No requests to export');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10; // 10mm margin
            const contentWidth = pageWidth - (margin * 2);

            // Create a temporary container
            const downloadContainer = document.createElement('div');
            downloadContainer.style.position = 'absolute';
            downloadContainer.style.left = '-9999px';
            downloadContainer.style.width = '1200px'; // Wide enough for landscape
            downloadContainer.style.background = 'white';
            downloadContainer.style.fontFamily = "'Amiri', serif";
            document.body.appendChild(downloadContainer);

            // Function to generate a single page chunk
            const generatePageHtml = (rows, pageNum, totalPages) => {
                return `
            <div style="padding: 20px; background: white;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <h2 style="color: var(--navy); margin: 0; font-size: 24px;">Maintenance Requests Report</h2>
                    <p style="color: #666; font-size: 12px; margin: 5px 0;">
                        Generated: ${new Date().toLocaleDateString()} | Page ${pageNum} of ${totalPages}
                    </p>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed;">
                    <thead>
                        <tr style="background: var(--navy); color: white; font-size:15px; text-align:center;">                            
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%;">Request No.</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 8%;">Status</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 15%;">College</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%;">Department</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%;">Location</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 30%;">Description</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%;">Date</th>
                            <th style="padding: 10px; border: 1px solid #ccc; width: 10%;">Estimated cost</th>

                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(req => `
                            <tr style="height: 50px; font-size:15px;text-align:center;">
                                <td style="padding: 8px; border: 1px solid #eee; text-align: center; font-weight: bold; word-wrap: break-word;">${req['Request Number'] || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; text-align: center;">${req.Status || 'Waiting'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; word-wrap: break-word;">${mapCollegeName(req.College) || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; word-wrap: break-word;">${req.Department || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; word-wrap: break-word;">${req.Location || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; direction: rtl; text-align: right; word-wrap: break-word;">${req.Description || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #eee; text-align: center;">${formatDate(req['Request Date'] || req.Date)}</td>
                                <td style="padding: 8px; border: 1px solid #eee; text-align: center; font-weight: 600; color: #567C8D;">${formatAmount(req['Request Number'])}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
            };

            // Split data into chunks (e.g., 10 rows per page)
            const rowsPerPage = 10;
            const totalPages = Math.ceil(filteredRequests.length / rowsPerPage);

            try {
                for (let i = 0; i < totalPages; i++) {
                    const start = i * rowsPerPage;
                    const end = start + rowsPerPage;
                    const chunk = filteredRequests.slice(start, end);

                    // Render chunk to container
                    downloadContainer.innerHTML = generatePageHtml(chunk, i + 1, totalPages);

                    // Wait for font rendering
                    await document.fonts.ready;

                    // Capture chunk as image
                    const canvas = await html2canvas(downloadContainer, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');

                    if (i > 0) doc.addPage();

                    // Calculate height to maintain aspect ratio within margins
                    const imgProps = doc.getImageProperties(imgData);
                    const displayHeight = (imgProps.height * contentWidth) / imgProps.width;

                    // Add image with margins
                    doc.addImage(imgData, 'PNG', margin, margin, contentWidth, displayHeight);
                }

                const filename = `Maintenance_Requests_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                console.log('‚úÖ PDF downloaded with proper margins and breaks');

            } catch (error) {
                console.error('‚ùå Download error:', error);
                alert('Error generating PDF: ' + error.message);
            } finally {
                if (downloadContainer.parentNode) {
                    document.body.removeChild(downloadContainer);
                }
            }

        });
    </script>
    <script>
        // Global dashboard navigation based on user role
        window.goToDashboard = function () {
            const role = sessionStorage.getItem('userRole');

            console.log('üöÄ Dashboard clicked - Role:', role);

            if (!role) {
                console.warn('‚ö†Ô∏è No role found, redirecting to default');
                window.location.href = 'all-requests-d.html';
                return;
            }

            const roleLower = role.toLowerCase();

            if (roleLower === 'director') {
                console.log('üëë Redirecting to Director Dashboard');
                window.location.href = 'director-dashboard.html';
            } else if (roleLower === 'admin') {
                console.log('üõ†Ô∏è Redirecting to Admin Dashboard');
                window.location.href = 'admin-dashboard.html';
            } else {
                console.log('üìù Redirecting to Default Dashboard');
                window.location.href = 'all-requests-d.html';
            }
        };
    </script>
</body>

</html>